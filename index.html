<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Barberflix - Encontre a Barbearia Perfeita</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; overflow-x: hidden; }
        
        /* Header - Barbearias Page */
        nav { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 20px 50px; display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.95); transition: background 0.3s; }
        nav.scrolled { background: rgba(0,0,0,0.95); }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 28px; font-weight: bold; cursor: pointer; transition: opacity 0.3s; }
        .logo-icon { width: 40px; height: 40px; background: #e50914; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 24px; height: 24px; fill: #fff; }
        .logo-text { display: flex; align-items: center; }
        .logo-text .barber { color: #fff; }
        .logo-text .flix { color: #e50914; }
        .logo:hover { opacity: 0.8; }
        .nav-buttons { display: flex; gap: 16px; align-items: center; flex: 1; justify-content: flex-end; position: relative; }
        .nav-buttons button { white-space: nowrap; margin: 0; }
        .nav-buttons > * { margin: 0; }
        #clientNavMenu { 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%);
            z-index: 1;
        }
        #userGreeting { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            width: 100%; 
            justify-content: flex-end; 
            position: relative; 
        }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; min-height: 40px; }
        .btn-outline { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.3); }
        .btn-outline:hover { background: rgba(255,255,255,0.1); }
        .btn-primary { background: #e50914; color: #fff; }
        .btn-primary:hover { background: #f40612; transform: scale(1.05); }
        .btn-register-shop { background: #ffc107; color: #000; font-weight: 600; padding: 10px 18px; }
        .btn-register-shop:hover { background: #ffb300; }
        .user-greeting { color: #fff; margin-right: 15px; font-size: 14px; }
        .logout-btn-icon { width: 24px; height: 24px; fill: currentColor; }
        
        /* Navigation Menu for Clients */
        .client-nav-menu { display: flex; align-items: center; gap: 30px; }
        .client-nav-item { display: flex; align-items: center; gap: 8px; color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.3s; text-decoration: none; }
        .client-nav-item:hover { background: rgba(255,255,255,0.1); }
        .client-nav-item svg { width: 18px; height: 18px; fill: currentColor; }
        .client-nav-item.active { color: #e50914; background: rgba(229, 9, 20, 0.1); }
        .client-nav-item.active svg { fill: #e50914; }
        
        /* Hero Section */
        .hero-section { padding: 120px 20px 60px; text-align: center; background: linear-gradient(180deg, #000 0%, #1a0000 100%); }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; color: #e50914; font-size: 0.9rem; font-weight: 600; margin-bottom: 20px; }
        .hero-badge svg { width: 20px; height: 20px; fill: #e50914; }
        .hero-title { font-size: 3.5rem; font-weight: bold; margin-bottom: 15px; line-height: 1.2; }
        .hero-title .highlight { color: #e50914; }
        .hero-subtitle { color: #ccc; font-size: 1.2rem; margin-bottom: 40px; max-width: 700px; margin-left: auto; margin-right: auto; }
        .search-container { max-width: 900px; margin: 0 auto; display: flex; gap: 15px; margin-bottom: 50px; }
        .search-bar { flex: 1; position: relative; }
        .search-bar input { width: 100%; padding: 15px 15px 15px 50px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 16px; font-family: inherit; }
        .search-bar input::placeholder { color: #999; }
        .search-bar input:focus { outline: none; border-color: #e50914; background: rgba(255,255,255,0.15); }
        .search-bar svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; fill: #999; }
        .city-filter-btn { padding: 15px 25px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 16px; transition: all 0.3s; white-space: nowrap; }
        .city-filter-btn:hover { background: rgba(255,255,255,0.15); border-color: #e50914; }
        .city-filter-btn svg { width: 20px; height: 20px; fill: #e50914; }
        
        /* Barbershops Container */
        .barbershops-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .section-title { font-size: 2rem; font-weight: bold; color: #fff; }
        .section-count { color: #999; font-size: 1rem; }
        .barbershops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .barbershop-card { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; cursor: pointer; transition: all 0.3s; position: relative; pointer-events: auto !important; }
        .barbershop-card:hover { transform: translateY(-5px); border-color: #e50914; box-shadow: 0 10px 30px rgba(229, 9, 20, 0.3); }
        .barbershop-card > *:not(.favorite-btn):not(.share-btn) { pointer-events: auto; }
        .barbershop-image { width: 100%; height: 200px; background: linear-gradient(135deg, #e50914 0%, #b20710 100%); display: flex; align-items: center; justify-content: center; font-size: 4rem; position: relative; overflow: hidden; }
        .barbershop-image::before { content: '✂️'; position: absolute; opacity: 0.3; z-index: 0; }
        .barbershop-image img { width: 100%; height: 100%; object-fit: cover; position: relative; z-index: 1; }
        .barbershop-info { padding: 20px; position: relative; }
        .barbershop-profile-img { position: absolute; top: -50px; left: 20px; width: 80px; height: 80px; border-radius: 50%; border: 3px solid #1a1a1a; object-fit: cover; z-index: 2; background: #1a1a1a; }
        .barbershop-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #e50914; margin-top: 40px; }
        .barbershop-detail { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #ccc; font-size: 0.9rem; }
        .barbershop-detail svg { width: 16px; height: 16px; fill: #e50914; flex-shrink: 0; }
        .barbershop-description { color: #999; margin-top: 15px; line-height: 1.5; font-size: 0.9rem; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state h2 { font-size: 2rem; margin-bottom: 10px; }
        
        /* Modal */
        .modal { 
            display: none !important; 
            visibility: hidden !important; 
            opacity: 0 !important;
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            right: 0 !important; 
            bottom: 0 !important; 
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,0.9) !important; 
            z-index: 2000 !important; 
            align-items: center !important; 
            justify-content: center !important; 
            transition: opacity 0.3s ease;
            overflow-y: auto;
        }
        .modal.active { 
            display: flex !important; 
            visibility: visible !important;
            opacity: 1 !important;
        }
        .modal-content { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 40px; max-width: 800px; width: 90%; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 20px; right: 20px; background: none; border: none; color: #fff; font-size: 30px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s; }
        .close-modal:hover { background: rgba(255,255,255,0.1); }
        .modal-content .form-group label { color: #ccc; }
        .modal-content .form-group input, .modal-content .form-group select, .modal-content .form-group textarea { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px; font-family: inherit; }
        .modal-content .form-group input:focus, .modal-content .form-group select:focus, .modal-content .form-group textarea:focus { outline: none; border-color: #e50914; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #e50914; }
        .checkbox-group label { color: #ccc; font-size: 14px; cursor: pointer; margin: 0; }
        
        /* Plans Modal */
        .plans-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .plan-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .plan-card:hover { border-color: #e50914; transform: translateY(-5px); }
        .plan-card.selected { border-color: #e50914; background: rgba(229, 9, 20, 0.1); }
        .plan-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .plan-price { font-size: 32px; font-weight: bold; color: #e50914; margin-bottom: 5px; }
        .plan-period { color: #999; font-size: 14px; margin-bottom: 20px; }
        .plan-features { list-style: none; text-align: left; margin: 20px 0; }
        .plan-features li { padding: 8px 0; color: #ccc; }
        .plan-features li::before { content: '✓ '; color: #e50914; font-weight: bold; margin-right: 8px; }
        
        /* Share Button & Modal */
        .share-btn, .favorite-btn { position: absolute; top: 15px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; z-index: 5; pointer-events: auto; }
        .share-btn { right: 15px; }
        .favorite-btn { right: 60px; }
        .share-btn:hover, .favorite-btn:hover { background: rgba(229, 9, 20, 0.9); transform: scale(1.1); }
        .share-btn svg, .favorite-btn svg { width: 20px; height: 20px; fill: #fff; }
        .favorite-btn.favorited { background: rgba(255, 255, 255, 0.9); }
        .favorite-btn.favorited svg { fill: #e50914; stroke: #e50914; stroke-width: 0.5; }
        .favorite-btn:hover.favorited { background: rgba(255, 255, 255, 1); transform: scale(1.15); }
        .share-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .share-option { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .share-option:hover { border-color: #e50914; background: rgba(229, 9, 20, 0.1); transform: translateY(-3px); }
        .share-option svg { width: 32px; height: 32px; margin-bottom: 10px; }
        .share-option span { display: block; color: #fff; font-size: 14px; font-weight: 500; }
        .share-link-input { display: flex; gap: 10px; margin-top: 20px; }
        .share-link-input input { flex: 1; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 14px; }
        .share-link-input button { padding: 12px 20px; background: #e50914; border: none; border-radius: 5px; color: #fff; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .share-link-input button:hover { background: #f40612; }
        .copy-success { color: #0f0; font-size: 12px; margin-top: 5px; display: none; }
        .copy-success.show { display: block; }
        
        /* Appointments Styles */
        .appointments-list { display: flex; flex-direction: column; gap: 15px; }
        .appointment-card { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            padding: 20px; 
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .appointment-card:hover { 
            border-color: #e50914; 
            background: rgba(255,255,255,0.08);
            transform: translateX(5px);
        }
        .appointment-info { flex: 1; }
        .appointment-shop-name { 
            font-size: 1.3rem; 
            font-weight: bold; 
            color: #e50914; 
            margin-bottom: 8px; 
        }
        .appointment-details { 
            display: flex; 
            flex-direction: column; 
            gap: 6px; 
            color: #ccc; 
            font-size: 0.95rem; 
        }
        .appointment-detail-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .appointment-detail-item svg { 
            width: 16px; 
            height: 16px; 
            fill: #e50914; 
        }
        .appointment-actions { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .appointment-status { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            text-align: center;
        }
        .status-confirmed { 
            background: rgba(76, 175, 80, 0.2); 
            color: #4caf50; 
            border: 1px solid #4caf50;
        }
        .status-pending { 
            background: rgba(255, 193, 7, 0.2); 
            color: #ffc107; 
            border: 1px solid #ffc107;
        }
        .status-cancelled { 
            background: rgba(244, 67, 54, 0.2); 
            color: #f44336; 
            border: 1px solid #f44336;
        }
        .status-completed { 
            background: rgba(158, 158, 158, 0.2); 
            color: #9e9e9e; 
            border: 1px solid #9e9e9e;
        }
        
        /* Alert Styles */
        .alert { 
            padding: 12px 16px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            font-size: 14px; 
            display: none;
            transition: all 0.3s;
        }
        .alert.show { 
            display: block !important; 
        }
        .alert-success { 
            background: rgba(76, 175, 80, 0.2); 
            border: 1px solid #4caf50; 
            color: #4caf50; 
        }
        .alert-error { 
            background: rgba(229, 9, 20, 0.2); 
            border: 1px solid #e50914; 
            color: #e50914; 
        }
        .alert-info { 
            background: rgba(33, 150, 243, 0.2); 
            border: 1px solid #2196f3; 
            color: #2196f3; 
        }
        
        /* Time Picker Styles */
        .time-picker-container {
            margin-bottom: 20px;
        }
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        .time-slot {
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            font-weight: 500;
            position: relative;
        }
        .time-slot:hover:not(.disabled):not(.selected) {
            background: rgba(255,255,255,0.1);
            border-color: rgba(229, 9, 20, 0.5);
            transform: translateY(-2px);
        }
        .time-slot.selected {
            background: #e50914;
            border-color: #e50914;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
        }
        .time-slot.disabled {
            background: rgba(255,255,255,0.02);
            border-color: rgba(255,255,255,0.05);
            color: #666;
            cursor: not-allowed;
            opacity: 0.5;
            text-decoration: line-through;
        }
        .time-slot.past {
            opacity: 0.4;
        }
        .time-picker-loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
        .time-picker-empty {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
        }
        .time-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .time-picker-info {
            font-size: 0.85rem;
            color: #999;
        }
        
        /* Otimizações de Performance */
        * { 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Melhorias de Touch */
        button, .btn, .barbershop-card {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, select {
            touch-action: manipulation;
        }
        
        @media (max-width: 1024px) {
            .barbershops-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .nav-buttons { gap: 12px; }
        }
        
        @media (max-width: 768px) { 
            nav { padding: 15px 20px; flex-wrap: wrap; }
            .nav-buttons { gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
            .nav-buttons button { padding: 8px 14px; font-size: 13px; min-height: 36px; margin: 0; }
            .btn-register-shop { padding: 8px 12px !important; font-size: 12px !important; }
            .hero-section { padding: 100px 15px 40px !important; }
            .hero-title { font-size: 2rem !important; }
            .hero-subtitle { font-size: 1rem !important; }
            .search-container { flex-direction: column !important; }
            .search-bar input { padding: 12px 12px 12px 45px; font-size: 16px; -webkit-appearance: none; appearance: none; }
            .city-filter-btn { width: 100%; justify-content: center; }
            .barbershops-container { padding: 20px 15px !important; }
            .section-header { flex-direction: column; align-items: flex-start !important; gap: 10px; }
            .section-title { font-size: 1.5rem !important; }
            .barbershops-grid { grid-template-columns: 1fr !important; gap: 20px !important; }
            .barbershop-card { border-radius: 12px; }
            .barbershop-image { height: 180px !important; }
            .barbershop-info { padding: 15px !important; }
            .barbershop-profile-img { width: 70px !important; height: 70px !important; top: -40px !important; left: 15px !important; border-width: 2px !important; }
            .barbershop-name { font-size: 1.3rem !important; margin-top: 35px !important; margin-bottom: 8px !important; }
            .barbershop-detail { font-size: 0.85rem !important; margin-bottom: 6px !important; }
            .barbershop-detail svg { width: 14px !important; height: 14px !important; }
            .barbershop-description { font-size: 0.85rem !important; margin-top: 12px !important; line-height: 1.4 !important; }
            .empty-state { padding: 40px 15px !important; }
            .empty-state h2 { font-size: 1.5rem !important; }
            .modal-content { padding: 30px 20px; width: 95%; max-height: 95vh; }
            .form-group input, .form-group textarea { 
                font-size: 16px; 
                padding: 14px; 
                -webkit-appearance: none;
                appearance: none;
            }
            .plans-grid { grid-template-columns: 1fr !important; }
            .share-options { grid-template-columns: repeat(2, 1fr) !important; }
            .time-slots-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 8px !important; }
            .time-slot { padding: 10px 12px !important; font-size: 0.85rem !important; }
            .client-nav-menu { gap: 15px !important; }
            .user-greeting { font-size: 12px !important; }
        }
        @media (max-width: 480px) {
            nav { padding: 12px 15px; }
            .logo { font-size: 20px; }
            .nav-buttons { gap: 8px; flex-wrap: wrap; }
            .nav-buttons button { padding: 6px 12px; font-size: 12px; width: 100%; }
            .barbershops-container { padding: 15px 10px !important; }
            .barbershops-header h1 { font-size: 1.5rem !important; }
            .barbershop-image { height: 160px !important; }
            .barbershop-profile-img { width: 60px !important; height: 60px !important; top: -35px !important; }
            .barbershop-name { font-size: 1.2rem !important; margin-top: 30px !important; }
            .barbershop-info { padding: 12px !important; }
            .modal-content { padding: 25px 15px; }
            .form-group { margin-bottom: 15px; }
            .share-options { grid-template-columns: 1fr !important; }
            .time-slots-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 6px !important; }
            .time-slot { padding: 8px 10px !important; font-size: 0.8rem !important; }
            .client-nav-menu { display: none !important; }
        }
        
        @media (max-width: 360px) {
            nav { padding: 10px 12px; }
            .logo { font-size: 18px; }
            .barbershops-container { padding: 12px 8px !important; }
            .modal-content { padding: 20px 12px; }
        }
    </style>
</head>
<body>
    <!-- Barbearias Page - Always visible -->
    <nav id="nav">
        <div class="logo" onclick="showHome(); return false;">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" style="fill: #fff;">
                    <path d="M9.5 2c-1.1 0-2 .9-2 2v2H5c-1.1 0-2 .9-2 2v2c0 .6.3 1.1.7 1.4L4 12l-.3.6c-.4.3-.7.8-.7 1.4v2c0 1.1.9 2 2 2h2.5v2c0 1.1.9 2 2 2h1c1.1 0 2-.9 2-2v-2H15c1.1 0 2-.9 2-2v-2c0-.6-.3-1.1-.7-1.4L16 12l.3-.6c.4-.3.7-.8.7-1.4V8c0-1.1-.9-2-2-2h-2.5V4c0-1.1-.9-2-2-2h-1z"/>
                </svg>
            </div>
            <div class="logo-text">
                <span class="barber">Barber</span><span class="flix">flix</span>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-register-shop" onclick="openModal('plans')" id="registerShopBtn">Cadastrar Barbearia</button>
            <span id="userGreeting" style="display: none;">
                <!-- Menu de navegação para clientes -->
                <div class="client-nav-menu" id="clientNavMenu" style="display: none;">
                    <a href="#" class="client-nav-item active" onclick="showHome(); return false;" id="navHome">
                        <svg viewBox="0 0 24 24"><path d="M4 4h6v6H4V4zm10 0h6v6h-6V4zM4 14h6v6H4v-6zm10 0h6v6h-6v-6z"/></svg>
                        <span>Início</span>
                    </a>
                    <!-- Menu "Meus Agendamentos" removido para evitar timeout -->
                    <a href="#" class="client-nav-item" onclick="showFavorites(); return false;" id="navFavorites">
                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        <span>Favoritos</span>
                    </a>
                </div>
                <span class="user-greeting" id="userGreetingText">Olá, Usuário</span>
                <button class="btn btn-outline" onclick="handleLogout()" id="logoutBtn" title="Sair" style="padding: 8px; min-width: 40px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" class="logout-btn-icon">
                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                </button>
            </span>
            <span id="loginButtons" style="display: flex; gap: 16px; align-items: center;">
            <button class="btn btn-outline" onclick="openModal('login')">Entrar</button>
            <button class="btn btn-primary" onclick="openModal('register')">Criar conta</button>
            </span>
        </div>
    </nav>

    <div id="barbershopsContent" style="padding-top: 100px; min-height: 100vh; background: linear-gradient(180deg, #000 0%, #1a0000 100%);">
        <!-- Content will be loaded here -->
            </div>

    <!-- Login Modal -->
    <div id="login" class="modal">
        <div class="modal-content" style="max-width: 450px; padding: 50px 40px; background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid rgba(255,255,255,0.1);">
            <button class="close-modal" onclick="closeModal('login')" style="top: 15px; right: 15px;">&times;</button>
            
            <div style="text-align: center; margin-bottom: 40px;">
                <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                     alt="Barberflix Logo" 
                     style="max-width: 180px; height: auto; margin-bottom: 25px; display: block; margin-left: auto; margin-right: auto;">
                <h2 style="margin-bottom: 10px; font-size: 2.2rem; color: #fff; font-weight: bold;">Login</h2>
                <p style="color: #999; font-size: 1rem; margin: 0;">Faça login para continuar</p>
                </div>
            
            <div id="loginAlert" class="alert"></div>
            
            <form id="loginForm" onsubmit="event.preventDefault(); handleLogin(event); return false;" style="margin-bottom: 25px;">
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Email</label>
                    <input type="email" id="loginEmail" required 
                           style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 16px; transition: all 0.3s;"
                           onfocus="this.style.borderColor='#e50914'; this.style.background='rgba(255,255,255,0.08)'"
                           onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Senha</label>
                    <input type="password" id="loginPassword" required 
                           style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 16px; transition: all 0.3s;"
                           onfocus="this.style.borderColor='#e50914'; this.style.background='rgba(255,255,255,0.08)'"
                           onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'">
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 25px;">
                    <input type="checkbox" id="rememberMe" 
                           style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer; accent-color: #e50914;">
                    <label for="rememberMe" style="color: #ccc; font-size: 0.95rem; cursor: pointer; margin: 0;">Manter conectado</label>
            </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 8px; margin-bottom: 20px;">
                    Entrar
                </button>
            </form>
            
            <div style="display: flex; align-items: center; margin: 25px 0; gap: 10px;">
                <div style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></div>
                <span style="color: #666; font-size: 0.9rem;">ou</span>
                <div style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></div>
        </div>
            
            <button type="button" onclick="handleGoogleLogin()" 
                    style="width: 100%; padding: 14px; background: #fff; color: #000; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; margin-bottom: 25px;"
                    onmouseover="this.style.background='#f5f5f5'"
                    onmouseout="this.style.background='#fff'">
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar com Google
            </button>
            
            <div style="text-align: center; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="color: #999; font-size: 0.95rem; margin: 0;">
                    Não tem uma conta? 
                    <a href="#" onclick="closeModal('login'); openModal('register');" 
                       style="color: #e50914; text-decoration: none; font-weight: 600; margin-left: 5px;"
                       onmouseover="this.style.textDecoration='underline'"
                       onmouseout="this.style.textDecoration='none'">Criar conta</a>
                </p>
                </div>
                </div>
                </div>

    <!-- Register Modal -->
    <div id="register" class="modal">
        <div class="modal-content" style="max-width: 450px; padding: 50px 40px; background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid rgba(255,255,255,0.1);">
            <button class="close-modal" onclick="closeModal('register')" style="top: 15px; right: 15px;">&times;</button>
            <div style="text-align: center; margin-bottom: 40px;">
                <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                     alt="Barberflix Logo" 
                     style="max-width: 180px; height: auto; margin-bottom: 25px; display: block; margin-left: auto; margin-right: auto;">
                <h2 style="margin-bottom: 10px; font-size: 2.2rem; color: #fff; font-weight: bold;">Criar Conta</h2>
                <p style="color: #999; font-size: 1rem; margin: 0;">Cadastre-se para continuar</p>
                </div>
            <div id="registerAlert" class="alert"></div>
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Telefone *</label>
                    <input type="tel" id="registerPhone" required>
            </div>
                <div class="form-group">
                    <label>Senha *</label>
                    <input type="password" id="registerPassword" required minlength="6">
        </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Criar Conta</button>
            </form>
            </div>
        </div>

    <!-- Plans Modal -->
    <div id="plans" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-modal" onclick="closeModal('plans')">&times;</button>
            <h2 style="margin-bottom: 30px; font-size: 2rem; color: #fff; text-align: center;">Escolha seu Plano</h2>
            <p style="color: #ccc; text-align: center; margin-bottom: 30px;">Selecione o plano ideal para sua barbearia</p>
            
            <div class="plans-grid">
                <div class="plan-card" onclick="selectPlan('basic', this)">
                    <div class="plan-name">Básico</div>
                    <div class="plan-price">R$ 49</div>
                    <div class="plan-period">/mês</div>
                    <ul class="plan-features">
                        <li>1 barbearia</li>
                        <li>Até 100 agendamentos/mês</li>
                        <li>Perfil completo</li>
                        <li>Suporte por email</li>
                </ul>
            </div>
                
                <div class="plan-card selected" onclick="selectPlan('premium', this)">
                    <div class="plan-name">Premium</div>
                    <div class="plan-price">R$ 99</div>
                    <div class="plan-period">/mês</div>
                    <ul class="plan-features">
                        <li>1 barbearia</li>
                        <li>Agendamentos ilimitados</li>
                        <li>Perfil completo + destaque</li>
                        <li>Estatísticas detalhadas</li>
                        <li>Suporte prioritário</li>
                        <li>Link de compartilhamento</li>
                </ul>
            </div>
                
                <div class="plan-card" onclick="selectPlan('enterprise', this)">
                    <div class="plan-name">Enterprise</div>
                    <div class="plan-price">R$ 199</div>
                    <div class="plan-period">/mês</div>
                    <ul class="plan-features">
                        <li>Múltiplas barbearias</li>
                        <li>Agendamentos ilimitados</li>
                        <li>Todos os recursos Premium</li>
                        <li>API personalizada</li>
                        <li>Suporte 24/7</li>
                        <li>Gestão centralizada</li>
                </ul>
            </div>
        </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-top: 30px;" onclick="proceedToRegister()">Continuar</button>
        </div>
    </div>

    <!-- Auth Required Modal -->
    <div id="authRequired" class="modal">
        <div class="modal-content" style="max-width: 450px; padding: 50px 40px; text-align: center; background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid rgba(255,255,255,0.1);">
            <button class="close-modal" onclick="closeModal('authRequired')" style="top: 15px; right: 15px;">&times;</button>
            
            <div style="margin-bottom: 40px;">
                <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                     alt="Barberflix Logo" 
                     style="max-width: 150px; height: auto; margin-bottom: 25px; display: block; margin-left: auto; margin-right: auto;">
                <h2 style="margin-bottom: 15px; font-size: 2.2rem; color: #fff; font-weight: bold;">Login Necessário</h2>
                <p style="color: #999; margin-bottom: 0; font-size: 1rem; line-height: 1.6;">
                    Faça login para continuar agendando
                </p>
                </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 30px;">
                <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 8px;" onclick="proceedToLogin()">
                    Entrar
                </button>
                <button class="btn btn-outline" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 8px; border-color: rgba(255,255,255,0.2);" onclick="proceedToRegister()">
                    Criar conta
                </button>
                </div>
                </div>
    </div>

    <!-- Barbershop Details Modal -->
    <div id="barbershopDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; padding: 0;">
            <button class="close-modal" onclick="closeModal('barbershopDetailsModal')" style="position: absolute; top: 15px; right: 15px; z-index: 10;">&times;</button>
            
            <div id="barbershopDetailsContent" style="padding: 0;">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- City Filter Modal -->
    <div id="cityFilterModal" class="modal">
        <div class="modal-content" style="max-width: 500px; padding: 40px; background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid rgba(255,255,255,0.1);">
            <button class="close-modal" onclick="closeModal('cityFilterModal')" style="top: 15px; right: 15px;">&times;</button>
            <h2 style="margin-bottom: 25px; font-size: 2rem; color: #fff; text-align: center;">Filtrar por Cidade</h2>
            
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <div id="cityList" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Cidades serão inseridas aqui -->
                </div>
                </div>
            
            <button class="btn btn-outline" onclick="clearCityFilter()" style="width: 100%; padding: 12px; border-radius: 8px;">
                Todas as cidades
            </button>
                </div>
                </div>

    <!-- My Appointments Modal -->
    <div id="myAppointmentsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; padding: 40px;">
            <button class="close-modal" onclick="closeModal('myAppointmentsModal')">&times;</button>
            <h2 style="margin-bottom: 30px; font-size: 2rem; color: #fff; text-align: center;">Meus Agendamentos</h2>
            
            <div id="appointmentsLoading" style="text-align: center; padding: 40px; color: #999;">
                <p>Carregando agendamentos...</p>
            </div>
            
            <div id="appointmentsContent" style="display: none;">
                <!-- Tabs para Futuros e Passados -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <button id="tabUpcoming" onclick="switchAppointmentsTab('upcoming')" 
                            style="padding: 12px 24px; background: #e50914; color: #fff; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Próximos
                    </button>
                    <button id="tabPast" onclick="switchAppointmentsTab('past')" 
                            style="padding: 12px 24px; background: transparent; color: #999; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        Passados
                    </button>
                </div>
                
                <!-- Lista de agendamentos futuros -->
                <div id="upcomingAppointments" class="appointments-list">
                    <!-- Será preenchido dinamicamente -->
                </div>
                
                <!-- Lista de agendamentos passados -->
                <div id="pastAppointments" class="appointments-list" style="display: none;">
                    <!-- Será preenchido dinamicamente -->
                </div>
                
                <!-- Mensagem quando não há agendamentos -->
                <div id="noAppointments" class="empty-state" style="display: none; text-align: center; padding: 60px 20px;">
                    <svg viewBox="0 0 24 24" style="width: 64px; height: 64px; fill: #666; margin-bottom: 20px;">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                    </svg>
                    <h3 style="color: #fff; margin-bottom: 10px; font-size: 1.5rem;">Nenhum agendamento encontrado</h3>
                    <p style="color: #999; margin-bottom: 30px;">Você ainda não possui agendamentos.</p>
                    <button class="btn btn-primary" onclick="closeModal('myAppointmentsModal'); loadBarbershops();">
                        Ver Barbearias
                    </button>
                </div>
            </div>
                </div>
                </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px; padding: 40px;">
            <button class="close-modal" onclick="closeModal('appointmentModal')">&times;</button>
            <h2 style="margin-bottom: 10px; font-size: 2rem; color: #fff; text-align: center;">Agendar Horário</h2>
            <p id="appointmentShopName" style="color: #e50914; text-align: center; margin-bottom: 30px; font-size: 1.1rem; font-weight: 600;"></p>
            
            <div id="appointmentAlert" class="alert"></div>
            
            <form id="appointmentForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Data</label>
                    <input type="date" id="appointmentDate" required 
                           style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 16px;"
                           onfocus="this.style.borderColor='#e50914'; this.style.background='rgba(255,255,255,0.08)'"
                           onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'"
                           min="">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Profissional *</label>
                    <select id="appointmentProfessional" required
                           style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 16px; cursor: pointer;"
                           onfocus="this.style.borderColor='#e50914'; this.style.background='rgba(255,255,255,0.08)'"
                           onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'">
                        <option value="">Selecione um profissional</option>
                    </select>
                    <div id="professionalInfo" style="margin-top: 10px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; display: none;">
                        <p style="color: #999; font-size: 0.85rem; margin: 4px 0;"><strong style="color: #ccc;">Especialidade:</strong> <span id="professionalSpecialty"></span></p>
                        <p style="color: #999; font-size: 0.85rem; margin: 4px 0;"><strong style="color: #ccc;">Telefone:</strong> <span id="professionalPhone"></span></p>
                        <p style="color: #999; font-size: 0.85rem; margin: 4px 0;"><strong style="color: #ccc;">WhatsApp:</strong> <span id="professionalWhatsApp"></span></p>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Horário</label>
                    <input type="hidden" id="appointmentTime" required>
                    <div class="time-picker-container">
                        <div class="time-picker-header">
                            <span style="color: #ccc; font-size: 0.9rem;">Selecione um horário disponível</span>
                            <span class="time-picker-info" id="timePickerInfo"></span>
                        </div>
                        <div id="timeSlotsContainer" class="time-slots-grid">
                            <div class="time-picker-loading">Carregando horários disponíveis...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Serviço (opcional)</label>
                    <div id="appointmentServices" style="display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; padding: 5px;">
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <p>Carregando serviços...</p>
                        </div>
                    </div>
                    <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Selecione o serviço desejado (opcional)</small>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="color: #ccc; font-size: 0.95rem; margin-bottom: 8px; display: block;">Observações (opcional)</label>
                    <textarea id="appointmentNotes" rows="4" 
                              style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 16px; font-family: inherit; resize: vertical;"
                              onfocus="this.style.borderColor='#e50914'; this.style.background='rgba(255,255,255,0.08)'"
                              onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'"
                              placeholder="Ex: Detalhes adicionais sobre o serviço"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 8px;">
                    Confirmar Agendamento
                </button>
            </form>
                </div>
                </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeModal('shareModal')">&times;</button>
            <h2 style="margin-bottom: 30px; font-size: 2rem; color: #fff;">Compartilhar Barbearia</h2>
            <p style="color: #ccc; margin-bottom: 20px;" id="shareShopName">Compartilhe esta barbearia com seus amigos!</p>
            
            <div class="share-link-input">
                <input type="text" id="shareLinkInput" readonly>
                <button onclick="copyShareLink()">Copiar</button>
            </div>
            <div class="copy-success" id="copySuccess">Link copiado com sucesso!</div>
            
            <div class="share-options">
                <div class="share-option" onclick="shareWhatsApp()">
                    <svg viewBox="0 0 24 24" fill="#25D366">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    <span>WhatsApp</span>
                </div>
                <div class="share-option" onclick="shareEmail()">
                    <svg viewBox="0 0 24 24" fill="#EA4335">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                    <span>Email</span>
                </div>
                <div class="share-option" onclick="shareFacebook()">
                    <svg viewBox="0 0 24 24" fill="#1877F2">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    <span>Facebook</span>
                </div>
                <div class="share-option" onclick="shareTwitter()">
                    <svg viewBox="0 0 24 24" fill="#1DA1F2">
                        <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"/>
                    </svg>
                    <span>Twitter</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tvvqwlxmpmolnyavabqq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dnF3bHhtcG1vbG55YXZhYnFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5MjMsImV4cCI6MjA3ODY2NDkyM30.5FW2R9rcYXpAvpAjWnviBRIjeQOVf2pZwWrYrqljdHw';
        
        // Verificar se Supabase está carregado
        let supabase;
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
            // Criar cliente Supabase (persistSession é true por padrão)
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('✅ Cliente Supabase criado com sucesso');
        } else {
            console.error('❌ Biblioteca Supabase não encontrada! Verifique se o CDN está carregando.');
            supabase = null;
        }
        
        const ADMIN_EMAILS = ['henrikocarlos69@gmail.com'];
        
        // Variável global para controlar se o login está sendo processado
        let isHandlingLogin = false;
        
        // Variável global para armazenar o usuário logado (SIMPLES!)
        window.currentUser = null;
        
        // Scroll header
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('nav');
            if (window.scrollY > 50) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });
        
        // Admin access oculto - clique 5x no logo
        let logoClicks = 0;
        document.querySelector('.logo').addEventListener('click', (e) => {
            logoClicks++;
            if (logoClicks >= 5) {
                logoClicks = 0;
                const email = prompt('🔐 Acesso Admin\nDigite o email admin:');
                if (email && ADMIN_EMAILS.includes(email)) {
                    window.location.href = 'barberflix-admin.html';
                } else if (email) {
                    alert('Email não autorizado.');
                }
            }
            setTimeout(() => logoClicks = 0, 2000);
        });
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('❌ Modal não encontrado:', modalId);
                return false;
            }
            
            console.log('🚪 Abrindo modal:', modalId);
            
            // Se for modal de agendamento, atualizar nome da barbearia
            if (modalId === 'appointmentModal' && window.currentAppointmentShopName) {
                const shopNameEl = document.getElementById('appointmentShopName');
                if (shopNameEl) {
                    shopNameEl.textContent = window.currentAppointmentShopName;
                    console.log('✅ Nome da barbearia atualizado:', window.currentAppointmentShopName);
                }
                
                // Definir data mínima como hoje
                const dateInput = document.getElementById('appointmentDate');
                if (dateInput) {
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.min = today;
                    if (!dateInput.value) {
                        dateInput.value = today;
                    }
                    console.log('✅ Data configurada:', today);
                }
                
                // Serviços removidos - não precisa limpar
                
                // Limpar alerta
                const alert = document.getElementById('appointmentAlert');
                if (alert) {
                    alert.textContent = '';
                    alert.className = 'alert';
                    alert.style.display = 'none';
                }
            }
            
            // Adicionar classe active primeiro
            modal.classList.add('active');
            
            // Determinar z-index baseado no tipo de modal
            let zIndex = '2000';
            if (modalId === 'login' || modalId === 'register' || modalId === 'authRequired' || modalId === 'appointmentModal') {
                zIndex = '9999'; // Modais importantes ficam por cima
            }
            
            // Forçar display imediatamente com estilo inline usando cssText para sobrescrever tudo
            modal.style.cssText = `
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: ${zIndex} !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(0,0,0,0.9) !important;
            `;
            
            document.body.style.overflow = 'hidden';
            
            // Verificar se realmente abriu
            const computedStyle = getComputedStyle(modal);
            const isVisible = computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden';
            
            console.log('✅ Modal aberto:', modalId, {
                display: computedStyle.display,
                visibility: computedStyle.visibility,
                opacity: computedStyle.opacity,
                zIndex: computedStyle.zIndex,
                isVisible: isVisible
            });
            
            if (!isVisible) {
                console.error('❌ Modal não está visível após tentativa de abertura!');
                // Tentar novamente com requestAnimationFrame
                requestAnimationFrame(() => {
                    modal.style.cssText = `
                        display: flex !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        z-index: ${zIndex} !important;
                        align-items: center !important;
                        justify-content: center !important;
                        background: rgba(0,0,0,0.9) !important;
                    `;
                });
            }
            
            return true;
        }
        window.openModal = openModal;
        
        function closeModal(modalId) {
            console.log('closeModal chamado para:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Fechando modal:', modalId);
                modal.classList.remove('active');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.zIndex = '2000';
                document.body.style.overflow = ''; // Restaurar scroll
                
                // Limpar seletor de horários, serviços e profissional se for modal de agendamento
                if (modalId === 'appointmentModal') {
                    const timeInput = document.getElementById('appointmentTime');
                    const timeSlotsContainer = document.getElementById('timeSlotsContainer');
                    const timePickerInfo = document.getElementById('timePickerInfo');
                    const servicesContainer = document.getElementById('appointmentServices');
                    const professionalSelect = document.getElementById('appointmentProfessional');
                    const professionalInfo = document.getElementById('professionalInfo');
                    if (timeInput) timeInput.value = '';
                    if (timeSlotsContainer) timeSlotsContainer.innerHTML = '<div class="time-picker-loading">Carregando horários disponíveis...</div>';
                    if (timePickerInfo) timePickerInfo.textContent = '';
                    if (servicesContainer) servicesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><p>Carregando serviços...</p></div>';
                    if (professionalSelect) {
                        professionalSelect.innerHTML = '<option value="">Selecione um profissional</option>';
                        professionalSelect.value = '';
                        professionalSelect.dataset.hasListener = ''; // Resetar flag do listener
                    }
                    if (professionalInfo) professionalInfo.style.display = 'none';
                }
                
                console.log('✅ Modal fechado:', modalId);
            } else {
                console.warn('Modal não encontrado:', modalId);
            }
        }
        window.closeModal = closeModal;
        
        // Função para mostrar alertas nos modais
        function showAlert(alertElement, message, type = 'info') {
            if (!alertElement) return;
            
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            alertElement.style.padding = '12px 16px';
            alertElement.style.borderRadius = '8px';
            alertElement.style.marginBottom = '20px';
            alertElement.style.fontSize = '14px';
            alertElement.style.transition = 'all 0.3s';
            
            // Remover classes anteriores
            alertElement.className = 'alert';
            
            if (type === 'success') {
                alertElement.style.background = 'rgba(76, 175, 80, 0.2)';
                alertElement.style.border = '1px solid rgba(76, 175, 80, 0.5)';
                alertElement.style.color = '#4caf50';
            } else if (type === 'error') {
                alertElement.style.background = 'rgba(229, 9, 20, 0.2)';
                alertElement.style.border = '1px solid rgba(229, 9, 20, 0.5)';
                alertElement.style.color = '#e50914';
            } else if (type === 'warning') {
                alertElement.style.background = 'rgba(255, 152, 0, 0.2)';
                alertElement.style.border = '1px solid rgba(255, 152, 0, 0.5)';
                alertElement.style.color = '#ff9800';
            } else {
                alertElement.style.background = 'rgba(33, 150, 243, 0.2)';
                alertElement.style.border = '1px solid rgba(33, 150, 243, 0.5)';
                alertElement.style.color = '#2196f3';
            }
            
            // Auto-ocultar após 5 segundos para mensagens de sucesso
            if (type === 'success') {
                setTimeout(() => {
                    if (alertElement) {
                        alertElement.style.display = 'none';
                    }
                }, 5000);
            }
        }
        window.showAlert = showAlert;
        
        async function handleLogin(e) {
            console.log('=== handleLogin CHAMADO ===');
            if (e) {
            e.preventDefault();
                e.stopPropagation();
            }
            
            const alert = document.getElementById('loginAlert');
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const rememberCheck = document.getElementById('rememberMe');
            
            console.log('Elementos encontrados:', {
                alert: !!alert,
                emailInput: !!emailInput,
                passwordInput: !!passwordInput,
                rememberCheck: !!rememberCheck
            });
            
            if (!emailInput || !passwordInput) {
                console.error('❌ Campos de login não encontrados!');
                if (alert) {
                    showAlert(alert, 'Erro: Campos de login não encontrados. Recarregue a página.', 'error');
                } else {
                    alert('Erro: Campos de login não encontrados. Recarregue a página.');
                }
                return;
            }
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            console.log('Tentando fazer login com email:', email);
            
            if (!email || !password) {
                console.error('Email ou senha vazios!');
                if (alert) {
                    showAlert(alert, 'Por favor, preencha email e senha.', 'error');
                }
                return;
            }
            
            if (!supabase) {
                console.error('❌ Supabase não está disponível!');
                if (alert) {
                    showAlert(alert, 'Erro: Supabase não está configurado corretamente.', 'error');
                }
                return;
            }
            
            try {
                // Marcar que está processando login
                isHandlingLogin = true;
                
                console.log('Chamando signInWithPassword...');
                const shouldPersist = rememberCheck ? rememberCheck.checked : true;
                console.log('Persistir sessão:', shouldPersist);
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                    options: { 
                        persistSession: shouldPersist,
                        emailRedirectTo: undefined
                    }
                });
                
                console.log('Resposta do signInWithPassword:', { hasData: !!data, hasError: !!error });
                
                if (error) {
                    console.error('❌ Erro no login:', error);
                    // Se for erro de email não confirmado, tentar confirmar automaticamente
                    if (error.message && (error.message.includes('not confirmed') || error.message.includes('Email not confirmed'))) {
                        console.log('Tentando reenviar confirmação...');
                        if (alert) showAlert(alert, 'Confirmando email automaticamente...', 'success');
                        // Tentar reenviar confirmação ou fazer login mesmo assim
                        const { error: retryError } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password,
                            options: { 
                                persistSession: rememberCheck ? rememberCheck.checked : true
                            }
                        });
                        if (retryError) {
                            console.error('❌ Erro no retry:', retryError);
                            throw retryError;
                        }
                    } else {
                        throw error;
                    }
                }
                
                console.log('✅ Login bem-sucedido!', data);
                
                if (!data || !data.user) {
                    throw new Error('Usuário não retornado na resposta de login');
                }
                
                console.log('Usuário retornado:', data.user.email);
                
                // SALVAR USUÁRIO GLOBALMENTE (SIMPLES!)
                window.currentUser = data.user;
                console.log('✅ Usuário salvo globalmente:', window.currentUser.id);
                
                // ATUALIZAR UI ANTES DE FECHAR O MODAL - CRÍTICO!
                console.log('=== ATUALIZANDO UI IMEDIATAMENTE ===');
                const userGreeting = document.getElementById('userGreeting');
                const loginButtons = document.getElementById('loginButtons');
                const clientNavMenu = document.getElementById('clientNavMenu');
                const registerShopBtn = document.getElementById('registerShopBtn');
                
                console.log('Elementos encontrados:', {
                    userGreeting: !!userGreeting,
                    loginButtons: !!loginButtons,
                    clientNavMenu: !!clientNavMenu,
                    registerShopBtn: !!registerShopBtn
                });
                
                if (userGreeting && loginButtons) {
                    // FORÇAR atualização IMEDIATA e AGRESSIVA
                    userGreeting.style.cssText = 'display: inline-flex !important; visibility: visible !important; opacity: 1 !important;';
                    loginButtons.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
                    
                    // Atualizar texto
                    const greetingText = document.getElementById('userGreetingText');
                    if (greetingText) {
                        const firstName = data.user.email?.split('@')[0] || 'Usuário';
                        greetingText.textContent = `Olá, ${firstName}`;
                    }
                    
                    // Mostrar menu de navegação
                    if (clientNavMenu) {
                        clientNavMenu.style.cssText = 'display: flex !important; visibility: visible !important;';
                    }
                    
                    // Esconder botão de cadastrar barbearia
                    if (registerShopBtn) {
                        registerShopBtn.style.cssText = 'display: none !important;';
                    }
                    
                    console.log('✅ UI ATUALIZADA IMEDIATAMENTE!');
                    console.log('Verificação imediata:', {
                        userGreetingDisplay: getComputedStyle(userGreeting).display,
                        loginButtonsDisplay: getComputedStyle(loginButtons).display
                    });
                } else {
                    console.error('❌ Elementos não encontrados para atualizar UI!');
                }
                
                // Fechar modal de login IMEDIATAMENTE (sem delay)
                console.log('Fechando modal de login...');
                closeModal('login');
                
                // Mostrar mensagem de sucesso (opcional, pode remover se quiser)
                // if (alert) {
                //     showAlert(alert, 'Login realizado com sucesso!', 'success');
                // }
                
                // Buscar perfil em paralelo (não bloquear) - SEM DELAY
                let profile = null;
                const profilePromise = (async () => {
                    try {
                        const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('user_type')
                    .eq('id', data.user.id)
                            .maybeSingle();
                        
                        if (profileError) {
                            console.warn('Erro ao buscar perfil:', profileError);
                        } else {
                            profile = profileData;
                            console.log('Perfil encontrado:', profile);
                        }
                    } catch (profileError) {
                        console.warn('Erro ao buscar perfil:', profileError);
                    }
                })();
                
                // Aguardar apenas o mínimo necessário para o modal fechar
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Verificar tipo de usuário e redirecionar ou atualizar UI
                    if (ADMIN_EMAILS.includes(data.user.email)) {
                    console.log('Redirecionando para admin...');
                        window.location.href = 'barberflix-admin.html';
                    return;
                }
                
                // Aguardar perfil se necessário
                await profilePromise;
                
                if (profile?.user_type === 'barber') {
                    console.log('Redirecionando para barbeiro...');
                        window.location.href = 'barberflix-barbeiro.html';
                    return;
                }
                
                // Cliente: UI já foi atualizada acima, apenas garantir que não seja sobrescrita
                console.log('Cliente logado, verificando se UI está correta...');
                
                // Verificar e forçar novamente após um pequeno delay para garantir
                setTimeout(() => {
                    const userGreetingCheck = document.getElementById('userGreeting');
                    const loginButtonsCheck = document.getElementById('loginButtons');
                    const clientNavMenuCheck = document.getElementById('clientNavMenu');
                    const registerShopBtnCheck = document.getElementById('registerShopBtn');
                    
                    const userGreetingComputed = userGreetingCheck ? getComputedStyle(userGreetingCheck).display : 'none';
                    const loginButtonsComputed = loginButtonsCheck ? getComputedStyle(loginButtonsCheck).display : 'none';
                    
                    console.log('Verificação após delay:', {
                        userGreetingInline: userGreetingCheck?.style.display,
                        userGreetingComputed: userGreetingComputed,
                        loginButtonsInline: loginButtonsCheck?.style.display,
                        loginButtonsComputed: loginButtonsComputed
                    });
                    
                    // Se ainda não está exibindo, forçar novamente com !important
                    if (userGreetingCheck && userGreetingComputed !== 'inline-flex' && userGreetingComputed !== 'flex') {
                        console.warn('⚠️ userGreeting ainda não está exibindo, forçando novamente...');
                        userGreetingCheck.style.cssText = 'display: inline-flex !important; visibility: visible !important; opacity: 1 !important;';
                        
                        // Mostrar menu de navegação também
                        if (clientNavMenuCheck) {
                            clientNavMenuCheck.style.cssText = 'display: flex !important; visibility: visible !important;';
                        }
                    }
                    if (loginButtonsCheck && loginButtonsComputed !== 'none') {
                        console.warn('⚠️ loginButtons ainda está exibindo, forçando novamente...');
                        loginButtonsCheck.style.cssText = 'display: none !important; visibility: hidden !important;';
                    }
                    if (registerShopBtnCheck && registerShopBtnCheck.style.display !== 'none') {
                        registerShopBtnCheck.style.cssText = 'display: none !important;';
                    }
                    
                    // Verificação final
                    setTimeout(() => {
                        const finalCheck = document.getElementById('userGreeting');
                        const finalComputed = finalCheck ? getComputedStyle(finalCheck).display : 'none';
                        console.log('Verificação final:', {
                            display: finalCheck?.style.display,
                            computed: finalComputed,
                            visible: finalComputed !== 'none'
                        });
                    }, 100);
                }, 300);
                
                // NÃO chamar updateUserInfo imediatamente - pode sobrescrever a UI
                // Aguardar mais tempo e verificar se a UI ainda está correta antes de chamar
                console.log('Aguardando antes de chamar updateUserInfo...');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Verificar se a UI ainda está correta antes de chamar updateUserInfo
                const userGreetingBeforeUpdate = document.getElementById('userGreeting');
                const loginButtonsBeforeUpdate = document.getElementById('loginButtons');
                const userGreetingDisplay = userGreetingBeforeUpdate ? getComputedStyle(userGreetingBeforeUpdate).display : 'none';
                const loginButtonsDisplay = loginButtonsBeforeUpdate ? getComputedStyle(loginButtonsBeforeUpdate).display : 'none';
                
                console.log('Estado da UI antes de updateUserInfo:', {
                    userGreetingDisplay: userGreetingDisplay,
                    loginButtonsDisplay: loginButtonsDisplay
                });
                
                // Se a UI já está correta, não precisa chamar updateUserInfo
                if (userGreetingDisplay === 'inline-flex' || userGreetingDisplay === 'flex') {
                    console.log('✅ UI já está correta, pulando updateUserInfo para evitar sobrescrever');
                    } else {
                    console.log('⚠️ UI não está correta, chamando updateUserInfo...');
                    try {
                        await updateUserInfo();
                        console.log('✅ updateUserInfo concluído');
                    } catch (updateError) {
                        console.error('Erro em updateUserInfo:', updateError);
                    }
                }
                
                // Buscar perfil em background para atualizar nome completo depois
                (async () => {
                    try {
                        const { data: profileData } = await supabase
                            .from('profiles')
                            .select('full_name')
                            .eq('id', data.user.id)
                            .maybeSingle();
                        
                        if (profileData?.full_name) {
                            const greetingText = document.getElementById('userGreetingText');
                            if (greetingText) {
                                const firstName = profileData.full_name.split(' ')[0];
                                greetingText.textContent = `Olá, ${firstName}`;
                                console.log('✅ Nome completo atualizado:', firstName);
                            }
                        }
                    } catch (err) {
                        console.warn('Erro ao buscar nome completo:', err);
                    }
                })();
                
                // Recarregar barbearias se necessário (sem bloquear)
                        if (!window.allBarbershops || window.allBarbershops.length === 0) {
                    console.log('Recarregando barbearias...');
                    loadBarbershops().catch(err => console.error('Erro ao recarregar barbearias:', err));
                        }
                        
                        // Se havia uma barbearia selecionada antes do login, mostrar agora
                    if (window.selectedShopId) {
                        const shopId = window.selectedShopId;
                        window.selectedShopId = null;
                        // Reduzir delay para 200ms
                        setTimeout(() => {
                            showBarbershopDetails(shopId);
                        }, 200);
                    }
                
                console.log('✅ Processo de login concluído!');
                
                // Liberar flag após processar login (aumentado para 3 segundos)
                setTimeout(() => {
                    isHandlingLogin = false;
                    console.log('Flag isHandlingLogin liberada');
                }, 3000);
            } catch (error) {
                // Liberar flag em caso de erro também
                isHandlingLogin = false;
                console.error('❌ ERRO em handleLogin:', error);
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);
                const errorMessage = error.message || 'Erro desconhecido ao fazer login.';
                if (alert) {
                    showAlert(alert, errorMessage, 'error');
                } else {
                    alert('Erro ao fazer login: ' + errorMessage);
                }
            }
        }
        window.handleLogin = handleLogin;
        
        async function handleRegister(e) {
            e.preventDefault();
            const alert = document.getElementById('registerAlert');
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: document.getElementById('registerEmail').value,
                    password: document.getElementById('registerPassword').value,
                    options: {
                        data: {
                            full_name: document.getElementById('registerName').value,
                            phone: document.getElementById('registerPhone').value || null
                        }
                    }
                });
                
                if (error) {
                    // Se for erro de permissão, mostrar mensagem mais clara
                    if (error.message.includes('permission denied') || error.message.includes('table users')) {
                        throw new Error('Erro de permissão. Verifique as configurações do Supabase.');
                    }
                    throw error;
                }
                
                if (!data.user) {
                    throw new Error('Usuário não foi criado. Tente novamente.');
                }
                
                // Aguardar trigger criar perfil
                showAlert(alert, 'Criando perfil...', 'success');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Tentar atualizar perfil (pode já ter sido criado pelo trigger)
                let profileUpdated = false;
                for (let i = 0; i < 5; i++) {
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({
                            full_name: document.getElementById('registerName').value,
                            phone: document.getElementById('registerPhone').value || null,
                            user_type: 'client'
                        })
                        .eq('id', data.user.id);
                    
                    if (!updateError) {
                        profileUpdated = true;
                        break;
                    }
                    
                    // Se der erro 404, o perfil ainda não foi criado, aguardar mais
                    if (updateError.message.includes('No rows') || updateError.code === 'PGRST116') {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        continue;
                    }
                    
                    // Se der erro de permissão, tentar inserir
                    if (updateError.message.includes('permission denied') || updateError.message.includes('403')) {
                        // Tentar inserir perfil
                        const { error: insertError } = await supabase
                            .from('profiles')
                            .insert({
                                id: data.user.id,
                                email: document.getElementById('registerEmail').value,
                                full_name: document.getElementById('registerName').value,
                                phone: document.getElementById('registerPhone').value || null,
                                user_type: 'client'
                            });
                        
                        if (!insertError || insertError.message.includes('duplicate')) {
                            profileUpdated = true;
                            break;
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                if (!profileUpdated) {
                    showAlert(alert, 'Conta criada, mas houve problema ao criar perfil. Faça login e tente novamente.', 'error');
                    setTimeout(() => {
                        closeModal('registerModal');
                        openModal('loginModal');
                    }, 3000);
                    return;
                }
                
                showAlert(alert, 'Conta criada! Redirecionando...', 'success');
                setTimeout(async () => {
                    closeModal('register');
                    await updateUserInfo();
                    
                    // Recarregar barbearias para garantir que apareçam
                    if (!window.allBarbershops || window.allBarbershops.length === 0) {
                        await loadBarbershops();
                    }
                    
                    // Se havia uma barbearia selecionada antes do cadastro, mostrar agora
                    if (selectedShopId) {
                        const shopId = selectedShopId;
                        selectedShopId = null;
                        showBarbershopDetails(shopId);
                    }
                }, 2000);
            } catch (error) {
                showAlert(alert, error.message || 'Erro ao criar conta. Tente novamente.', 'error');
            }
        }
        
        let isLoadingBarbershops = false;
        
        async function loadBarbershops() {
            // Evitar múltiplas chamadas simultâneas
            if (isLoadingBarbershops) {
                console.log('Já está carregando barbearias, aguardando...');
                return;
            }
            
            // Se já tem barbearias carregadas e não precisa recarregar, não fazer nada
            if (window.allBarbershops && window.allBarbershops.length > 0) {
                console.log('Barbearias já carregadas, não precisa recarregar');
                return;
            }
            
            isLoadingBarbershops = true;
            
            const content = document.getElementById('barbershopsContent');
            if (!content) {
                console.error('Elemento barbershopsContent não encontrado');
                isLoadingBarbershops = false;
                return;
            }
            
            // Só criar o HTML se ainda não foi criado (evitar recriar toda vez)
            if (!document.getElementById('barbershopsList')) {
                content.innerHTML = `
                    <div class="hero-section">
                        <div class="hero-badge">
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <span>Sua barbearia ideal</span>
                        </div>
                        <h1 class="hero-title">
                            Encontre e agende com as<br>
                            <span class="highlight">melhores barbearias</span>
                        </h1>
                        <p class="hero-subtitle">Descubra profissionais qualificados perto de você e agende seu horário com facilidade</p>
                        
                        <div class="search-container">
                            <div class="search-bar">
                                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <input type="text" id="searchInput" placeholder="Buscar por nome ou bairro..." onkeyup="filterBarbershops()">
                </div>
                            <button class="city-filter-btn" onclick="openCityFilter()">
                                <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                                <span id="cityFilterText">Todas as cidades</span>
                            </button>
                        </div>
                    </div>
                    
                <div class="barbershops-container">
                        <div class="section-header">
                            <h2 class="section-title">Todas as Barbearias</h2>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="display: flex; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px;">
                                    <button id="filterAllBtn" onclick="showAll()" style="padding: 10px 20px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: #e50914; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">
                                        Todas
                                    </button>
                                    <button id="filterFavoritesBtn" onclick="showFavorites()" style="padding: 10px 20px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: #fff; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 6px;">
                                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                        </svg>
                                        Favoritos
                                    </button>
                                </div>
                                <span class="section-count" id="barbershopsCount">Carregando...</span>
                            </div>
                    </div>
                    <div id="barbershopsList" class="barbershops-grid">
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">
                            <p>Carregando barbearias...</p>
                        </div>
                    </div>
                </div>
            `;
                
                // Aguardar um pouco para garantir que o elemento foi criado
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Atualizar texto de carregamento se já existe
            const countElement = document.getElementById('barbershopsCount');
            if (countElement) {
                countElement.textContent = 'Carregando...';
            }
            
            try {
                console.log('Buscando barbearias no Supabase...');
                
                // Verificar se Supabase está disponível
                if (!supabase) {
                    throw new Error('❌ Cliente Supabase não foi criado. Verifique se a biblioteca Supabase está carregada.');
                }
                
                console.log('✅ Supabase client:', supabase ? 'OK' : 'NÃO ENCONTRADO');
                console.log('📍 URL do Supabase:', SUPABASE_URL);
                
                // Buscar dados diretamente do Supabase
                let data = null;
                let error = null;
                
                try {
                    console.log('🔍 Iniciando busca de barbearias...');
                    console.log('📍 Usando API REST direta do Supabase (bypass da biblioteca)');
                    
                    const startTime = Date.now();
                    
                    // SOLUÇÃO ALTERNATIVA: Usar fetch direto ao invés da biblioteca Supabase
                    // Isso evita problemas com a biblioteca que podem estar causando timeout
                    const SUPABASE_REST_URL = `${SUPABASE_URL}/rest/v1/barbershops`;
                    
                    console.log('📊 Fazendo requisição direta para:', SUPABASE_REST_URL);
                    console.log('⏱️ Início:', new Date().toISOString());
                    
                    // Timeout de segurança - 8 segundos
                    const TIMEOUT_MS = 8000;
                    
                    try {
                        const response = await Promise.race([
                            fetch(SUPABASE_REST_URL + '?select=*&limit=100', {
                                method: 'GET',
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation',
                                    'Range': '0-99' // Limitar a 100 registros
                                }
                            }),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error(`TIMEOUT: Requisição demorou mais de ${TIMEOUT_MS/1000} segundos`)), TIMEOUT_MS)
                            )
                        ]);
                        
                        const queryTime = Date.now() - startTime;
                        console.log(`⏱️ Requisição completou em ${(queryTime / 1000).toFixed(2)} segundos`);
                        console.log('📊 Status da resposta:', response.status, response.statusText);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('❌ Erro HTTP:', response.status, errorText);
                            throw new Error(`Erro HTTP ${response.status}: ${errorText || response.statusText}`);
                        }
                        
                        const responseData = await response.json();
                        console.log('✅ Dados recebidos! Total de registros:', responseData?.length || 0);
                        console.log('📋 Primeiro registro:', responseData?.[0]);
                        
                        // Formatar resultado no padrão esperado pela biblioteca Supabase
                        result = {
                            data: Array.isArray(responseData) ? responseData : [],
                            error: null
                        };
                        
                    } catch (fetchError) {
                        const queryTime = Date.now() - startTime;
                        console.error(`❌ Requisição falhou após ${(queryTime / 1000).toFixed(2)} segundos:`, fetchError);
                        
                        // Se deu timeout ou erro de rede, tentar método alternativo
                        if (fetchError.message?.includes('TIMEOUT') || fetchError.message?.includes('Failed to fetch')) {
                            console.warn('⚠️ Tentando método alternativo...');
                            
                            // Tentar sem limit para ver se resolve
                            try {
                                const altResponse = await Promise.race([
                                    fetch(SUPABASE_REST_URL + '?select=*', {
                                        method: 'GET',
                                        headers: {
                                            'apikey': SUPABASE_KEY,
                                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                                            'Content-Type': 'application/json'
                                        }
                                    }),
                                    new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Timeout método alternativo')), 5000)
                                    )
                                ]);
                                
                                if (altResponse.ok) {
                                    const altData = await altResponse.json();
                                    result = {
                                        data: Array.isArray(altData) ? altData : [],
                                        error: null
                                    };
                                    console.log('✅ Método alternativo funcionou!');
                                } else {
                                    throw new Error(`Método alternativo falhou: ${altResponse.status}`);
                                }
                            } catch (altError) {
                                throw fetchError; // Retornar erro original
                            }
                        } else {
                            throw fetchError;
                        }
                    }
                    
                    console.log('Resultado bruto da query:', {
                        hasData: !!result.data,
                        dataType: typeof result.data,
                        isArray: Array.isArray(result.data),
                        dataLength: result.data?.length,
                        error: result.error,
                        errorMessage: result.error?.message,
                        errorCode: result.error?.code,
                        errorDetails: result.error?.details,
                        errorHint: result.error?.hint
                    });
                    
                    // Verificar se retornou erro
                    if (result.error) {
                        console.error('❌ Erro da query Supabase:', result.error);
                        console.error('Código do erro:', result.error.code);
                        console.error('Mensagem:', result.error.message);
                        console.error('Detalhes:', result.error.details);
                        console.error('Hint:', result.error.hint);
                        
                        error = result.error;
                        
                        // Se o erro é de permissão RLS, fornecer detalhes específicos
                        if (result.error.code === 'PGRST301' || 
                            result.error.code === '42501' ||
                            result.error.message?.includes('permission denied') ||
                            result.error.message?.includes('RLS') ||
                            result.error.message?.includes('row-level security')) {
                            throw new Error(`❌ Acesso negado pelas políticas RLS: ${result.error.message || 'Erro desconhecido'}. Verifique se a política "Anyone can view barbershops" está habilitada para role "anon" com USING (true).`);
                        }
                        
                        // Se é erro de conexão/rede
                        if (result.error.message?.includes('Failed to fetch') || 
                            result.error.message?.includes('NetworkError') ||
                            result.error.message?.includes('network')) {
                            throw new Error(`🌐 Erro de conexão: ${result.error.message}. Verifique sua internet e a URL do Supabase (${SUPABASE_URL}).`);
                        }
                        
                        throw new Error(`Erro ao buscar dados: ${result.error.message || 'Erro desconhecido'} (Código: ${result.error.code || 'N/A'})`);
                    }
                    
                    if (result.data !== null && result.data !== undefined) {
                        data = Array.isArray(result.data) ? result.data : [];
                        error = null;
                        
                        console.log(`✅ ${data.length} barbearias encontradas`);
                        
                        // Ordenar no cliente se tiver dados
                        if (data.length > 0) {
                            data.sort((a, b) => {
                                const nameA = (a.name || '').toLowerCase();
                                const nameB = (b.name || '').toLowerCase();
                                return nameA.localeCompare(nameB);
                            });
                            console.log('📝 Dados ordenados no cliente');
                        }
                    } else {
                        console.warn('⚠️ Result.data é null ou undefined');
                        data = [];
                        error = null;
                    }
                } catch (queryError) {
                    console.error('❌ Erro ao executar query:', queryError);
                    console.error('Tipo do erro:', typeof queryError);
                    console.error('Erro completo:', JSON.stringify(queryError, null, 2));
                    
                    // Se é timeout, explicar melhor
                    if (queryError.message && (queryError.message.includes('TIMEOUT') || queryError.message.includes('Timeout'))) {
                        console.error('⏰ TIMEOUT DETECTADO: Query não retornou em 20 segundos');
                        const timeoutMsg = '⏱️ Query demorou mais de 20 segundos sem resposta do Supabase. ';
                        const possibleCauses = [
                            '✅ Sua política RLS está correta (USING true), mas há outro problema',
                            '🌐 Problema de conexão: Verifique sua internet e a URL do Supabase',
                            '🔒 A query pode estar sendo bloqueada mesmo com a política correta',
                            '🔍 Teste manual: No Supabase SQL Editor, execute: SELECT * FROM barbershops LIMIT 10',
                            '⚙️ Verifique se há problemas de CORS ou configuração do projeto Supabase',
                            '📊 A URL do Supabase pode estar incorreta ou o serviço pode estar indisponível'
                        ].join('\n');
                        error = new Error(timeoutMsg + possibleCauses);
                        throw error;
                    }
                    
                    error = queryError;
                    throw queryError;
                }
                
                console.log('Resultado da query:', { 
                    hasData: !!data,
                    count: data?.length || 0,
                    error: error?.message || null
                });
                
                // Se deu erro, tratar
                if (error) {
                    console.error('Erro na query:', error);
                    throw error;
                }
                
                const listElement = document.getElementById('barbershopsList');
                if (!listElement) {
                    console.error('Elemento barbershopsList não encontrado');
                    isLoadingBarbershops = false;
                    return;
                }
                
                if (!data || !Array.isArray(data) || data.length === 0) {
                    console.log('Nenhuma barbearia retornada ou dados inválidos');
                    console.log('Tipo de data:', typeof data);
                    console.log('É array?:', Array.isArray(data));
                    console.log('Valor de data:', data);
                    
                    const countElement = document.getElementById('barbershopsCount');
                    if (countElement) {
                        countElement.textContent = '0 barbearias encontradas';
                    }
                    
                    // Mostrar mensagem apropriada
                    const emptyMessage = error ? 
                        'Erro ao carregar barbearias. Verifique as permissões do Supabase (RLS).' :
                        'Nenhuma barbearia encontrada. Verifique se há barbearias cadastradas.';
                    
                    listElement.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <h2>Nenhuma barbearia encontrada</h2>
                            <p>${emptyMessage}</p>
                            ${error ? `<p style="color: #e50914; margin-top: 10px; font-size: 0.9rem;">${error.message || 'Erro desconhecido'}</p>` : ''}
                            <p style="color: #999; margin-top: 15px; font-size: 0.85rem;">
                                💡 Dica: No Supabase, crie uma política RLS para permitir leitura anônima:<br>
                                <code style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-top: 10px;">
                                    CREATE POLICY "Anyone can view barbershops" ON barbershops FOR SELECT TO anon USING (true);
                                </code>
                            </p>
                        </div>
                    `;
                    
                    // Armazenar array vazio para evitar tentativas infinitas
                    window.allBarbershops = [];
                    isLoadingBarbershops = false;
                    return;
                }
                
                console.log(`${data.length} barbearias encontradas`);
                console.log('Primeira barbearia (exemplo):', data[0]);
                
                // Armazenar todas as barbearias para filtros
                window.allBarbershops = data;
                window.currentFilter = window.currentFilter || 'all'; // Inicializar filtro
                renderBarbershops(data, listElement);
                updateBarbershopsCount(data.length);
                updateFilterButtons(); // Atualizar botões de filtro
                
            } catch (error) {
                console.error('Erro ao carregar barbearias:', error);
                
                const listElement = document.getElementById('barbershopsList');
                const countElement = document.getElementById('barbershopsCount');
                
                if (listElement) {
                    const errorMessage = error.message || 'Erro desconhecido';
                    const isRLSError = errorMessage.toLowerCase().includes('rls') || 
                                     errorMessage.toLowerCase().includes('timeout') ||
                                     errorMessage.toLowerCase().includes('políticas') ||
                                     errorMessage.toLowerCase().includes('blocked');
                    
                    listElement.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <h2>Erro ao carregar</h2>
                            <p style="color: #e50914;">${errorMessage}</p>
                            ${isRLSError && errorMessage.toLowerCase().includes('timeout') ? `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <p style="color: #fff; margin-bottom: 10px; font-weight: bold;">⏱️ Timeout - Query demorando muito</p>
                                    <p style="color: #999; font-size: 0.9rem; margin-bottom: 15px;">
                                        <strong>✅ Sua política RLS está correta</strong> (USING true), mas a query está demorando mais de 15 segundos. Possíveis causas:
                                    </p>
                                    <ol style="color: #999; font-size: 0.85rem; margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                        <li><strong>🌐 Conexão:</strong> Verifique sua internet e a URL do Supabase</li>
                                        <li><strong>📊 Tabela grande:</strong> Se há muitos registros, pode demorar. Considere paginação.</li>
                                        <li><strong>🔍 Verificar dados:</strong> Abra Supabase Dashboard → Table Editor → barbershops</li>
                                        <li><strong>💡 Teste manual:</strong> No SQL Editor, execute: <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">SELECT * FROM barbershops LIMIT 10</code></li>
                                        <li><strong>⚙️ Performance:</strong> Verifique se há índices na tabela</li>
                                    </ol>
                                    <p style="color: #999; font-size: 0.8rem; margin-top: 10px; padding: 10px; background: rgba(255, 152, 0, 0.05); border-radius: 4px;">
                                        💡 <strong>Dica:</strong> Se a query manual também demorar, o problema pode ser na infraestrutura do Supabase ou na quantidade de dados.
                                    </p>
                                </div>
                            ` : isRLSError ? `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(229, 9, 20, 0.1); border-radius: 8px; border-left: 4px solid #e50914;">
                                    <p style="color: #fff; margin-bottom: 10px; font-weight: bold;">⚠️ Problema de Políticas RLS</p>
                                    <p style="color: #999; font-size: 0.9rem; margin-bottom: 10px;">
                                        Verifique as políticas RLS na tabela <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">barbershops</code>:
                                    </p>
                                    <ol style="color: #999; font-size: 0.85rem; margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                                        <li>Abra o Supabase Dashboard → <strong>Authentication → Policies</strong></li>
                                        <li>Verifique a política <strong>"Anyone can view barbershops"</strong> para role <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">anon</code></li>
                                        <li>A condição <code>USING</code> deve ser apenas <code style="color: #4ade80;">true</code></li>
                                    </ol>
                                </div>
                            ` : ''}
                            <p style="color: #999; margin-top: 15px; font-size: 0.85rem;">
                                💡 Se o problema persistir, verifique também sua conexão com a internet e as configurações do projeto no Supabase.
                            </p>
                        </div>
                    `;
                }
                
                if (countElement) {
                    countElement.textContent = 'Erro ao carregar';
                }
                
                // Armazenar array vazio para evitar tentativas infinitas
                window.allBarbershops = [];
            } finally {
                // Sempre liberar o flag de carregamento
                isLoadingBarbershops = false;
            }
        }
        
        function updateBarbershopsCount(count) {
            const countElement = document.getElementById('barbershopsCount');
            if (countElement) {
                countElement.textContent = `${count} ${count === 1 ? 'barbearia encontrada' : 'barbearias encontradas'}`;
            }
        }
        
        function filterBarbershops() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const selectedCity = window.selectedCity || 'all';
            const showOnlyFavorites = window.currentFilter === 'favorites';
            let filtered = window.allBarbershops || [];
            
            // Filtrar por favoritos primeiro
            if (showOnlyFavorites) {
                const favorites = getFavorites();
                filtered = filtered.filter(shop => favorites.includes(shop.id));
            }
            
            if (searchTerm) {
                filtered = filtered.filter(shop => 
                    (shop.name || '').toLowerCase().includes(searchTerm) ||
                    (shop.address || '').toLowerCase().includes(searchTerm) ||
                    (shop.city || '').toLowerCase().includes(searchTerm) ||
                    (shop.neighborhood || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedCity !== 'all') {
                filtered = filtered.filter(shop => 
                    (shop.city || '').toLowerCase() === selectedCity.toLowerCase()
                );
            }
            
            const listElement = document.getElementById('barbershopsList');
            if (listElement) {
                if (filtered.length === 0) {
                    const message = showOnlyFavorites ? 
                        'Você ainda não favoritou nenhuma barbearia. Clique no coração para adicionar aos favoritos!' :
                        'Nenhuma barbearia encontrada. Tente ajustar sua busca ou filtro.';
                    
                    listElement.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <h2>${showOnlyFavorites ? 'Nenhum favorito' : 'Nenhuma barbearia encontrada'}</h2>
                            <p>${message}</p>
                        </div>
                    `;
                } else {
                    renderBarbershops(filtered, listElement);
                }
                updateBarbershopsCount(filtered.length);
            }
        }
        
        function showFavorites() {
            window.currentFilter = 'favorites';
            updateFilterButtons();
            filterBarbershops();
            
            // Atualizar menu ativo
            document.querySelectorAll('.client-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navFavorites = document.getElementById('navFavorites');
            if (navFavorites) {
                navFavorites.classList.add('active');
            }
        }
        window.showFavorites = showFavorites;
        
        function showHome() {
            window.currentFilter = 'all';
            updateFilterButtons();
            filterBarbershops();
            
            // Atualizar menu ativo
            document.querySelectorAll('.client-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navHome = document.getElementById('navHome');
            if (navHome) {
                navHome.classList.add('active');
            }
        }
        window.showHome = showHome;
        
        function showAll() {
            window.currentFilter = 'all';
            updateFilterButtons();
            filterBarbershops();
        }
        
        function updateFilterButtons() {
            const allBtn = document.getElementById('filterAllBtn');
            const favoritesBtn = document.getElementById('filterFavoritesBtn');
            const isFavorites = window.currentFilter === 'favorites';
            
            if (allBtn) {
                allBtn.style.background = isFavorites ? 'rgba(255,255,255,0.05)' : '#e50914';
                allBtn.style.borderColor = isFavorites ? 'rgba(255,255,255,0.2)' : '#e50914';
            }
            if (favoritesBtn) {
                favoritesBtn.style.background = isFavorites ? '#e50914' : 'rgba(255,255,255,0.05)';
                favoritesBtn.style.borderColor = isFavorites ? '#e50914' : 'rgba(255,255,255,0.2)';
            }
        }
        
        function openCityFilter() {
            const cities = [...new Set((window.allBarbershops || []).map(shop => shop.city).filter(Boolean))].sort();
            const cityListElement = document.getElementById('cityList');
            
            if (!cityListElement) {
                openModal('cityFilterModal');
                return;
            }
            
            // Limpar lista anterior
            cityListElement.innerHTML = '';
            
            // Adicionar opção "Todas as cidades"
            const allCitiesBtn = document.createElement('button');
            allCitiesBtn.className = 'btn btn-outline';
            allCitiesBtn.style.cssText = 'width: 100%; padding: 14px; text-align: left; border-radius: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; transition: all 0.3s;';
            allCitiesBtn.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;"><svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #e50914;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><span style="font-weight: 600;">Todas as cidades</span></div>`;
            allCitiesBtn.onclick = () => {
                clearCityFilter();
                closeModal('cityFilterModal');
            };
            allCitiesBtn.onmouseover = () => allCitiesBtn.style.background = 'rgba(255,255,255,0.1)';
            allCitiesBtn.onmouseout = () => allCitiesBtn.style.background = 'rgba(255,255,255,0.05)';
            cityListElement.appendChild(allCitiesBtn);
            
            // Adicionar cada cidade
            cities.forEach(city => {
                const cityBtn = document.createElement('button');
                cityBtn.className = 'btn btn-outline';
                cityBtn.style.cssText = 'width: 100%; padding: 14px; text-align: left; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; transition: all 0.3s;';
                cityBtn.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;"><svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #999;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><span>${city}</span></div>`;
                cityBtn.onclick = () => {
                    window.selectedCity = city;
                    document.getElementById('cityFilterText').textContent = city;
                    filterBarbershops();
                    closeModal('cityFilterModal');
                };
                cityBtn.onmouseover = () => cityBtn.style.background = 'rgba(255,255,255,0.1)';
                cityBtn.onmouseout = () => cityBtn.style.background = 'rgba(255,255,255,0.05)';
                cityListElement.appendChild(cityBtn);
            });
            
            if (cities.length === 0) {
                cityListElement.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhuma cidade disponível</p>';
            }
            
            openModal('cityFilterModal');
        }
        
        function clearCityFilter() {
            window.selectedCity = 'all';
            document.getElementById('cityFilterText').textContent = 'Todas as cidades';
            filterBarbershops();
        }
        
        // Funções de favoritos
        function getFavorites() {
            const favorites = localStorage.getItem('barberflix_favorites');
            return favorites ? JSON.parse(favorites) : [];
        }
        
        function saveFavorites(favorites) {
            localStorage.setItem('barberflix_favorites', JSON.stringify(favorites));
        }
        
        function toggleFavorite(shopId, event) {
            console.log('toggleFavorite chamado:', shopId);
            if (event) {
                event.stopPropagation();
            }
            const favorites = getFavorites();
            const index = favorites.indexOf(shopId);
            
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(shopId);
            }
            
            saveFavorites(favorites);
            updateFavoriteButtons();
            
            // Recarregar a lista se estiver na aba de favoritos
            if (window.currentFilter === 'favorites') {
                filterBarbershops();
            }
        }
        window.toggleFavorite = toggleFavorite;
        
        function isFavorite(shopId) {
            return getFavorites().includes(shopId);
        }
        
        function updateFavoriteButtons() {
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const shopId = btn.getAttribute('data-shop-id');
                if (shopId && isFavorite(shopId)) {
                    btn.classList.add('favorited');
                } else {
                    btn.classList.remove('favorited');
                }
            });
        }
        
        function renderBarbershops(data, listElement) {
            try {
                const favorites = getFavorites();
                
                listElement.innerHTML = data.map(shop => {
                    const escapedName = (shop.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const address = shop.address || '';
                    const city = shop.city || '';
                    const state = shop.state || '';
                    const fullAddress = address && city ? `${address}, ${city}${state ? ` - ${state}` : ''}` : '';
                    const isFav = favorites.includes(shop.id);
                    
                    return `
                    <div class="barbershop-card" data-shop-id="${shop.id}" 
                         onclick="if(typeof window.viewBarbershop === 'function') { const clicked = event.target.closest('.favorite-btn, .share-btn'); if(!clicked) { event.preventDefault(); event.stopPropagation(); window.viewBarbershop('${shop.id}'); } }"
                         style="cursor: pointer; position: relative; user-select: none; pointer-events: auto !important;">
                        <button class="favorite-btn ${isFav ? 'favorited' : ''}" 
                                data-shop-id="${shop.id}"
                                onclick="event.stopPropagation(); event.preventDefault(); if(typeof toggleFavorite === 'function') toggleFavorite('${shop.id}', event); return false;" 
                                title="${isFav ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}"
                                style="position: absolute; top: 15px; right: 60px; z-index: 10; cursor: pointer; pointer-events: auto;">
                            <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; pointer-events: none;">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                        <button class="share-btn" onclick="event.stopPropagation(); event.preventDefault(); if(typeof openShareModal === 'function') openShareModal('${shop.id}', '${escapedName}'); return false;" title="Compartilhar"
                                style="position: absolute; top: 15px; right: 15px; z-index: 10; cursor: pointer; pointer-events: auto;">
                            <svg viewBox="0 0 24 24" style="pointer-events: none;">
                                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                            </svg>
                        </button>
                        <div class="barbershop-image">
                            ${shop.cover_image ? `<img src="${shop.cover_image}" alt="${shop.name || 'Barbearia'}">` : ''}
                        </div>
                        <div class="barbershop-info">
                            ${shop.profile_image ? `<img src="${shop.profile_image}" alt="${shop.name || 'Barbearia'}" class="barbershop-profile-img">` : ''}
                            <div class="barbershop-name">${shop.name || 'Barbearia'}</div>
                            ${fullAddress ? `
                                <div class="barbershop-detail">
                                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                                    <span>${fullAddress}</span>
                                </div>
                            ` : ''}
                            ${shop.phone ? `
                                <div class="barbershop-detail">
                                    <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                                    <span>${shop.phone}</span>
                                </div>
                            ` : ''}
                            ${shop.description ? `
                                <div class="barbershop-description">${shop.description}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
                }).join('');
                console.log('Barbearias renderizadas com sucesso');
                
                // Atualizar botões de favorito após renderizar
                    updateFavoriteButtons();
                    
                // Garantir que os cards sejam clicáveis - usar requestAnimationFrame para garantir que o DOM foi atualizado
                requestAnimationFrame(() => {
                    const cards = listElement.querySelectorAll('.barbershop-card');
                    console.log(`✅ ${cards.length} cards encontrados para adicionar event listeners`);
                    
                    if (cards.length === 0) {
                        console.warn('⚠️ Nenhum card encontrado após renderização!');
                        return;
                    }
                    
                    cards.forEach((card, index) => {
                        const shopId = card.getAttribute('data-shop-id');
                        if (!shopId) {
                            console.warn(`⚠️ Card ${index} sem data-shop-id`);
                            return;
                        }
                        
                        // Remover qualquer listener antigo
                        const newCard = card.cloneNode(true);
                        card.parentNode.replaceChild(newCard, card);
                        
                        // Adicionar listener de clique no card
                        newCard.addEventListener('click', function(e) {
                            // Se clicou diretamente em botão, não fazer nada
                            if (e.target.closest('.favorite-btn') || e.target.closest('.share-btn')) {
                                console.log('Clique em botão ignorado');
                                return;
                            }
                            
                            console.log(`🎯 Card clicado! shopId: ${shopId}`);
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Chamar viewBarbershop
                            if (typeof window.viewBarbershop === 'function') {
                                console.log('Chamando viewBarbershop...');
                                window.viewBarbershop(shopId);
                            } else {
                                console.error('❌ window.viewBarbershop não está disponível!');
                                console.error('Funções disponíveis:', Object.keys(window).filter(k => k.includes('view') || k.includes('shop')));
                                alert('Erro: Função de visualização não disponível. Recarregue a página.');
                            }
                        }, { once: false, passive: false });
                        
                        // Garantir estilos
                        newCard.style.cursor = 'pointer';
                        newCard.style.pointerEvents = 'auto';
                        newCard.style.userSelect = 'none';
                        
                        // Adicionar hover effect
                        newCard.addEventListener('mouseenter', () => {
                            newCard.style.transform = 'translateY(-5px)';
                        });
                        newCard.addEventListener('mouseleave', () => {
                            newCard.style.transform = 'translateY(0)';
                        });
                    });
                    
                    console.log('✅ Event listeners adicionados aos cards');
                });
            } catch (error) {
                console.error('Erro ao renderizar barbearias:', error);
                listElement.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <h2>Erro ao renderizar</h2>
                        <p style="color: #f00;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        window.selectedShopId = null;
        
        async function viewBarbershop(shopId) {
            console.log('=== viewBarbershop CHAMADO ===');
            console.log('shopId:', shopId);
            
            if (!shopId) {
                console.error('shopId não fornecido!');
                alert('Erro: ID da barbearia não encontrado.');
                return;
            }
            
            try {
                // Sempre mostrar detalhes, independente de login
                console.log('Chamando showBarbershopDetails...');
                await showBarbershopDetails(shopId);
                console.log('showBarbershopDetails concluído');
            } catch (error) {
                console.error('ERRO em viewBarbershop:', error);
                console.error('Stack:', error.stack);
                alert('Erro ao abrir detalhes da barbearia: ' + error.message);
            }
        }
        
        // Tornar função global para onclick
        window.viewBarbershop = viewBarbershop;
        
        // Função para solicitar login para agendamento
        function requestLoginForAppointment(shopId) {
            console.log('Solicitando login para agendamento, shopId:', shopId);
            // Salvar shopId para depois do login
            window.selectedShopId = shopId;
            
            // Fechar modal de detalhes completamente
            const detailsModal = document.getElementById('barbershopDetailsModal');
            if (detailsModal) {
                detailsModal.classList.remove('active');
                detailsModal.style.display = 'none';
                detailsModal.style.visibility = 'hidden';
                detailsModal.style.opacity = '0';
                detailsModal.style.zIndex = '2000';
            }
            
            // Pequeno delay para garantir que o modal fechou
            setTimeout(() => {
                // Abrir modal de autenticação com z-index maior
                const authModal = document.getElementById('authRequired');
                if (authModal) {
                    authModal.classList.add('active');
                    authModal.style.display = 'flex';
                    authModal.style.visibility = 'visible';
                    authModal.style.opacity = '1';
                    authModal.style.position = 'fixed';
                    authModal.style.top = '0';
                    authModal.style.left = '0';
                    authModal.style.right = '0';
                    authModal.style.bottom = '0';
                    authModal.style.width = '100%';
                    authModal.style.height = '100%';
                    authModal.style.zIndex = '9999'; // Z-index maior que o modal de detalhes
                    authModal.style.alignItems = 'center';
                    authModal.style.justifyContent = 'center';
                    authModal.style.background = 'rgba(0,0,0,0.9)';
                    document.body.style.overflow = 'hidden';
                    console.log('Modal de autenticação aberto');
                } else {
                    console.error('Modal authRequired não encontrado!');
                }
            }, 150);
        }
        window.requestLoginForAppointment = requestLoginForAppointment;
        
        async function showBarbershopDetails(shopId) {
            console.log('=== INÍCIO showBarbershopDetails ===');
            console.log('shopId:', shopId);
            console.log('allBarbershops disponível:', !!window.allBarbershops);
            
            try {
                // Buscar dados completos da barbearia
                const shop = window.allBarbershops?.find(s => s.id === shopId);
                
                if (!shop) {
                    console.error('Barbearia não encontrada para ID:', shopId);
                    alert('Barbearia não encontrada.');
                    return;
                }
                
                console.log('✅ Barbearia encontrada:', shop.name);
                
                // Verificar se está logado - Verificar pela UI primeiro (mais rápido e confiável)
                // NÃO TRAVAR A ABERTURA DO MODAL - verificação rápida apenas
                let isLoggedIn = false;
                try {
                    // Verificar pela UI primeiro (instantâneo)
                    const userGreeting = document.getElementById('userGreeting');
                    const isLoggedInByUI = userGreeting && getComputedStyle(userGreeting).display !== 'none';
                    
                    if (isLoggedInByUI) {
                        console.log('✅ Usuário logado detectado pela UI');
                        isLoggedIn = true;
                    } else {
                        // Se UI não mostra logado, tentar getSession rápido (sem await longo)
                        if (supabase && supabase.auth && supabase.auth.getSession) {
                            try {
                                // Usar Promise.race com timeout curto para não travar
                                const sessionPromise = supabase.auth.getSession();
                                const timeoutPromise = new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Timeout rápido')), 500)
                                );
                                
                                const result = await Promise.race([sessionPromise, timeoutPromise]);
                                if (result?.data?.session?.user) {
                                    isLoggedIn = true;
                                    console.log('✅ Usuário logado detectado via getSession (rápido)');
                                }
                            } catch (quickError) {
                                // Ignorar timeout - assumir não logado
                                console.log('Verificação rápida de auth concluída (não logado ou timeout)');
                        isLoggedIn = false;
                    }
                        }
                    }
                    
                    console.log('✅ Auth verificado rapidamente, logado:', isLoggedIn);
                } catch (authError) {
                    console.warn('⚠️ Erro ao verificar autenticação (continuando):', authError.message);
                    isLoggedIn = false;
                }
                
                console.log('📋 Dados da barbearia:', {
                    id: shop.id,
                    name: shop.name,
                    phone: shop.phone,
                    hasPhone: !!shop.phone
                });
                console.log('🔨 Iniciando construção do HTML...');
                
                // Garantir que shop.phone seja uma string válida ou null
                const phoneValue = shop.phone ? String(shop.phone) : null;
                const shopNameValue = String(shop.name || 'Barbearia').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ').replace(/\r/g, '');
                
                console.log('📞 phoneValue:', phoneValue ? 'tem' : 'não tem');
                
                // Montar HTML do modal com detalhes
                let detailsHTML = '';
                console.log('🔨 Construindo template string...');
                try {
                    detailsHTML = `
                    <div style="position: relative;">
                        <!-- Imagem de capa -->
                        ${shop.cover_image ? `
                            <div style="width: 100%; height: 300px; overflow: hidden; background: #1a1a1a;">
                                <img src="${shop.cover_image}" alt="${shop.name || 'Barbearia'}" 
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        ` : `
                            <div style="width: 100%; height: 300px; background: linear-gradient(135deg, #e50914 0%, #b20710 100%); 
                                        display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 24 24" style="width: 120px; height: 120px; fill: rgba(255,255,255,0.3);">
                                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
                                </svg>
                            </div>
                        `}
                        
                        <!-- Conteúdo principal -->
                        <div style="padding: 40px;">
                            <!-- Cabeçalho com foto do perfil -->
                            <div style="display: flex; align-items: flex-start; gap: 25px; margin-bottom: 30px;">
                                ${shop.profile_image ? `
                                    <img src="${shop.profile_image}" alt="${shop.name || 'Barbearia'}" 
                                         style="width: 120px; height: 120px; border-radius: 15px; object-fit: cover; border: 4px solid #1a1a1a; margin-top: -60px; background: #1a1a1a;">
                                ` : `
                                    <div style="width: 120px; height: 120px; border-radius: 15px; background: linear-gradient(135deg, #e50914 0%, #b20710 100%); 
                                                margin-top: -60px; display: flex; align-items: center; justify-content: center; border: 4px solid #1a1a1a;">
                                        <svg viewBox="0 0 24 24" style="width: 60px; height: 60px; fill: rgba(255,255,255,0.5);">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                        </svg>
                                    </div>
                                `}
                                
                                <div style="flex: 1;">
                                    <h1 style="font-size: 2.5rem; margin-bottom: 10px; color: #fff; font-weight: bold;">
                                        ${shop.name || 'Barbearia'}
                                    </h1>
                                    
                                    ${shop.address || shop.city ? `
                                        <div style="display: flex; align-items: center; gap: 8px; color: #ccc; margin-bottom: 8px; font-size: 1.1rem;">
                                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #e50914;">
                                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                            </svg>
                                            <span>${shop.address || ''}${shop.address && shop.city ? ', ' : ''}${shop.city || ''}${shop.state ? ` - ${shop.state}` : ''}</span>
                                        </div>
                                    ` : ''}
                                    
                                    ${shop.phone ? `
                                        <div style="display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 1.1rem;">
                                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #e50914;">
                                                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                            </svg>
                                            <span>${shop.phone}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${shop.description ? `
                                <div style="margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; border-left: 4px solid #e50914;">
                                    <h3 style="color: #fff; margin-bottom: 10px; font-size: 1.3rem;">Sobre</h3>
                                    <p style="color: #ccc; line-height: 1.6; font-size: 1rem;">${shop.description}</p>
                                </div>
                            ` : ''}
                            
                            <!-- Botões de ação -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 30px;">
                                ${phoneValue ? `
                                    <button class="btn btn-primary" 
                                            onclick="contactWhatsApp('${phoneValue.replace(/\D/g, '')}', '${shopNameValue}')" 
                                            style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; font-size: 1rem; cursor: pointer;">
                                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: currentColor;">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                        </svg>
                                        Mensagem
                                    </button>
                                    
                                    <button class="btn btn-outline" 
                                            onclick="contactPhone('${phoneValue.replace(/\D/g, '')}')" 
                                            style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; font-size: 1rem; cursor: pointer;">
                                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: currentColor;">
                                            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                        </svg>
                                        Ligar
                                    </button>
                                ` : ''}
                                
                                ${isLoggedIn ? `
                                    <button class="btn btn-primary" 
                                            onclick="scheduleAppointment('${shopId}', '${shopNameValue}')" 
                                            style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; font-size: 1rem; background: #ffc107; color: #000; cursor: pointer;">
                                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: currentColor;">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                        Agendar
                                    </button>
                                ` : `
                                    <button class="btn btn-primary" 
                                            onclick="requestLoginForAppointment('${shopId}')" 
                                            style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; font-size: 1rem; background: #ffc107; color: #000; cursor: pointer;">
                                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: currentColor;">
                                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                        </svg>
                                        Agendar
                                    </button>
                                `}
                                
                                <button class="btn btn-outline" 
                                        onclick="openShareModal('${shopId}', '${shopNameValue}')" 
                                        style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; font-size: 1rem; cursor: pointer;">
                                    <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: currentColor;">
                                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                    </svg>
                                    Compartilhar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                } catch (htmlError) {
                    console.error('❌ ERRO ao construir HTML:', htmlError);
                    console.error('Stack:', htmlError.stack);
                    alert('Erro ao construir HTML: ' + htmlError.message);
                    throw htmlError;
                }
                
                console.log('✅ HTML construído, tamanho:', detailsHTML.length);
                
                // Preencher modal
                console.log('🔍 Buscando elementos do modal...');
                const modalContent = document.getElementById('barbershopDetailsContent');
                const modalElement = document.getElementById('barbershopDetailsModal');
                
                console.log('modalContent encontrado:', !!modalContent);
                console.log('modalElement encontrado:', !!modalElement);
                
                if (!modalContent) {
                    console.error('❌ barbershopDetailsContent não encontrado!');
                    alert('Erro: elemento do modal não encontrado.');
                    return;
                }
                
                if (!modalElement) {
                    console.error('❌ barbershopDetailsModal não encontrado!');
                    alert('Erro: modal não encontrado.');
                    return;
                }
                
                // Inserir HTML primeiro
                console.log('📝 Inserindo HTML no modal...');
                modalContent.innerHTML = detailsHTML;
                console.log('✅ HTML inserido');
                
                // ABRIR MODAL - VERSÃO SIMPLES E DIRETA
                console.log('🚪 Abrindo modal...');
                
                // Adicionar classe
                modalElement.classList.add('active');
                
                // Aplicar estilos diretamente
                modalElement.style.display = 'flex';
                modalElement.style.visibility = 'visible';
                modalElement.style.opacity = '1';
                modalElement.style.position = 'fixed';
                modalElement.style.top = '0';
                modalElement.style.left = '0';
                modalElement.style.right = '0';
                modalElement.style.bottom = '0';
                modalElement.style.width = '100%';
                modalElement.style.height = '100%';
                modalElement.style.zIndex = '9999';
                modalElement.style.alignItems = 'center';
                modalElement.style.justifyContent = 'center';
                modalElement.style.background = 'rgba(0,0,0,0.9)';
                
                document.body.style.overflow = 'hidden';
                
                console.log('✅ MODAL ABERTO COM SUCESSO!');
                console.log('=== FIM showBarbershopDetails ===');
            } catch (error) {
                console.error('Erro ao mostrar detalhes:', error);
                console.error('Stack trace:', error.stack);
                alert('Erro ao carregar detalhes da barbearia: ' + error.message);
            }
        }
        
        // Funções de contato
        function contactWhatsApp(phone, shopName) {
            console.log('contactWhatsApp chamado:', phone, shopName);
            const message = encodeURIComponent(`Olá! Gostaria de agendar um serviço na ${shopName}.`);
            const whatsappUrl = `https://wa.me/55${phone}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }
        window.contactWhatsApp = contactWhatsApp;
        
        function contactPhone(phone) {
            console.log('contactPhone chamado:', phone);
            window.location.href = `tel:+55${phone}`;
        }
        window.contactPhone = contactPhone;
        
        async function scheduleAppointment(shopId, shopName) {
            console.log('=== scheduleAppointment CHAMADO ===', { shopId, shopName });
            
            try {
                // Verificar se está logado pela UI primeiro (instantâneo, não bloqueia)
                const userGreeting = document.getElementById('userGreeting');
                const isLoggedInByUI = userGreeting && getComputedStyle(userGreeting).display !== 'none';
                
                console.log('✅ Verificação pela UI:', { isLoggedInByUI });
                
                // Se UI não mostra logado, pedir login IMEDIATAMENTE
                if (!isLoggedInByUI) {
                    console.log('❌ UI não mostra logado, abrindo modal de login');
                    closeModal('barbershopDetailsModal');
                    window.selectedShopId = shopId;
                    openModal('authRequired');
                    return;
                }
            
                // Se UI mostra logado, abrir modal IMEDIATAMENTE (não bloquear com verificações)
                console.log('✅ UI mostra logado, abrindo modal de agendamento IMEDIATAMENTE...');
                
                // Salvar shopId e shopName para o modal
                window.currentAppointmentShopId = shopId;
                window.currentAppointmentShopName = shopName;
                console.log('📝 Dados salvos:', { shopId, shopName });
                
                // Fechar modal de detalhes primeiro
                console.log('🚪 Fechando modal de detalhes...');
                closeModal('barbershopDetailsModal');
                
                // Pequeno delay para garantir que o modal anterior fechou
                await new Promise(resolve => setTimeout(resolve, 150));
                
                // Verificar se o modal existe
                const appointmentModal = document.getElementById('appointmentModal');
                if (!appointmentModal) {
                    console.error('❌ Modal appointmentModal não encontrado!');
                    alert('Erro: Modal de agendamento não encontrado.');
                    return;
                }
                
                // FORÇAR ABERTURA DO MODAL IMEDIATAMENTE
                console.log('🔧 FORÇANDO abertura do modal...');
                appointmentModal.classList.add('active');
                appointmentModal.style.cssText = `
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    z-index: 9999 !important;
                    align-items: center !important;
                    justify-content: center !important;
                    background: rgba(0,0,0,0.9) !important;
                `;
                document.body.style.overflow = 'hidden';
                
                // Também chamar openModal para garantir
                openModal('appointmentModal');
                
                // Configurar campos do modal
                const shopNameEl = document.getElementById('appointmentShopName');
                if (shopNameEl) {
                    shopNameEl.textContent = shopName;
                }
                
                const dateInput = document.getElementById('appointmentDate');
                if (dateInput) {
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.min = today;
                    if (!dateInput.value) {
                        dateInput.value = today;
                    }
                    
                    // Remover listeners anteriores usando uma flag
                    if (dateInput.dataset.hasListener === 'true') {
                        // Já tem listener, não adicionar novamente
                    } else {
                        dateInput.dataset.hasListener = 'true';
                        // Adicionar listener para mudança de data
                        dateInput.addEventListener('change', function() {
                            const selectedDate = this.value;
                            console.log('📅 Data alterada para:', selectedDate);
                            loadAvailableTimeSlots(shopId, selectedDate);
                        });
                    }
                }
                
                // Carregar profissionais da barbearia
                console.log('👥 Carregando profissionais da barbearia...');
                await loadBarbershopProfessionals(shopId);
                
                // Carregar horários disponíveis para a data inicial
                const initialDate = dateInput?.value || new Date().toISOString().split('T')[0];
                console.log('📅 Carregando horários para data:', initialDate);
                await loadAvailableTimeSlots(shopId, initialDate);
                
                // Carregar serviços da barbearia
                console.log('📋 Carregando serviços da barbearia...');
                await loadBarbershopServices(shopId);
                
                // Garantir que o formulário tem listener de submit
                const appointmentForm = document.getElementById('appointmentForm');
                if (appointmentForm) {
                    // Remover listener anterior se existir
                    appointmentForm.onsubmit = null;
                    // Adicionar novo listener
                    appointmentForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('📝 Formulário submetido! Chamando submitAppointment...');
                        submitAppointment().catch(err => {
                            console.error('❌ Erro ao executar submitAppointment:', err);
                        });
                        return false;
                    });
                    console.log('✅ Listener de submit adicionado ao formulário');
                } else {
                    console.error('❌ Formulário appointmentForm não encontrado!');
                }
                
                console.log('✅ MODAL DE AGENDAMENTO ABERTO!');
            } catch (error) {
                console.error('Erro em scheduleAppointment:', error);
                alert('Erro ao agendar: ' + error.message);
            }
        }
        window.scheduleAppointment = scheduleAppointment;
        
        // Função para buscar horários disponíveis da barbearia
        async function loadAvailableTimeSlots(shopId, selectedDate) {
            console.log('📅 === loadAvailableTimeSlots INICIADO ===');
            console.log('📅 shopId:', shopId);
            console.log('📅 selectedDate:', selectedDate);
            
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            const timePickerInfo = document.getElementById('timePickerInfo');
            const timeInput = document.getElementById('appointmentTime');
            
            if (!timeSlotsContainer) {
                console.error('❌ Container de horários não encontrado');
                return;
            }
            
            // Mostrar loading
            timeSlotsContainer.innerHTML = '<div class="time-picker-loading">Carregando horários disponíveis...</div>';
            if (timePickerInfo) timePickerInfo.textContent = '';
            if (timeInput) timeInput.value = '';
            
            try {
                if (!shopId) {
                    throw new Error('ID da barbearia não fornecido');
                }
                
                if (!selectedDate) {
                    throw new Error('Data não selecionada');
                }
                // Buscar configurações da barbearia (horários de funcionamento)
                let shop = null;
                if (window.allBarbershops) {
                    shop = window.allBarbershops.find(s => s.id === shopId);
                }
                
                // Se não encontrou, buscar do Supabase
                if (!shop && supabase) {
                    try {
                        const { data, error } = await supabase
                            .from('barbershops')
                            .select('*')
                            .eq('id', shopId)
                            .single();
                        if (!error && data) {
                            shop = data;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar barbearia:', e);
                    }
                }
                
                // Horários padrão se não houver configuração
                const defaultHours = {
                    start: '08:00',
                    end: '20:00',
                    interval: 30 // minutos
                };
                
                // Tentar buscar horários configurados da barbearia
                let shopHours = defaultHours;
                if (shop) {
                    // Se a barbearia tem horários configurados, usar eles
                    if (shop.business_hours) {
                        try {
                            const hours = typeof shop.business_hours === 'string' 
                                ? JSON.parse(shop.business_hours) 
                                : shop.business_hours;
                            if (hours.start && hours.end) {
                                shopHours = {
                                    start: hours.start,
                                    end: hours.end,
                                    interval: hours.interval || 30
                                };
                            }
                        } catch (e) {
                            console.warn('Erro ao parsear business_hours:', e);
                        }
                    }
                }
                
                console.log('⏰ Horários da barbearia:', shopHours);
                
                // Gerar todos os horários possíveis em intervalos de 30 minutos
                console.log('🔄 Gerando slots de horários...');
                const availableSlots = generateTimeSlots(shopHours.start, shopHours.end, shopHours.interval);
                console.log('✅ Slots gerados:', availableSlots.length, 'horários');
                
                // ❌ BUSCA DE AGENDAMENTOS EXISTENTES REMOVIDA PARA EVITAR TIMEOUT
                // Os horários ocupados não serão marcados, mas o agendamento funcionará normalmente
                let bookedSlots = [];
                console.log('ℹ️ Busca de agendamentos existentes desabilitada (para evitar timeout)');
                
                // Filtrar horários passados (se for hoje)
                console.log('🕐 Verificando horários passados...');
                const now = new Date();
                const isToday = selectedDate === now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().slice(0, 5); // HH:MM
                console.log('📅 É hoje?', isToday, 'Hora atual:', currentTime);
                
                // Renderizar slots
                console.log('🎨 Renderizando slots de horários...');
                renderTimeSlots(availableSlots, bookedSlots, isToday ? currentTime : null);
                console.log('✅ Slots renderizados!');
                
                // Atualizar info
                if (timePickerInfo) {
                    const availableCount = availableSlots.length - bookedSlots.length;
                    timePickerInfo.textContent = `${availableCount} horário${availableCount !== 1 ? 's' : ''} disponível${availableCount !== 1 ? 'is' : ''}`;
                    console.log('📊 Info atualizada:', timePickerInfo.textContent);
                }
                
                console.log('✅ === loadAvailableTimeSlots CONCLUÍDO ===');
                
            } catch (error) {
                console.error('❌ Erro ao carregar horários:', error);
                console.error('❌ Stack:', error.stack);
                
                let errorMessage = 'Erro ao carregar horários disponíveis.';
                if (error.message) {
                    errorMessage = error.message;
                }
                
                timeSlotsContainer.innerHTML = `
                    <div class="time-picker-empty">
                        <p style="color: #e50914; margin-bottom: 10px;">${errorMessage}</p>
                        <button onclick="if(window.loadAvailableTimeSlots) { window.loadAvailableTimeSlots('${shopId}', '${selectedDate || new Date().toISOString().split('T')[0]}'); }" 
                                style="margin-top: 10px; padding: 8px 16px; background: #e50914; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            Tentar Novamente
                        </button>
                    </div>
                `;
                
                if (timePickerInfo) {
                    timePickerInfo.textContent = 'Erro ao carregar';
                    timePickerInfo.style.color = '#e50914';
                }
            }
        }
        window.loadAvailableTimeSlots = loadAvailableTimeSlots;
        
        // Função para gerar slots de horários em intervalos regulares
        function generateTimeSlots(startTime, endTime, intervalMinutes = 30) {
            const slots = [];
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let currentHour = startHour;
            let currentMin = startMin;
            
            while (currentHour < endHour || (currentHour === endHour && currentMin <= endMin)) {
                const timeString = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
                slots.push(timeString);
                
                // Adicionar intervalo
                currentMin += intervalMinutes;
                if (currentMin >= 60) {
                    currentMin = 0;
                    currentHour++;
                }
            }
            
            return slots;
        }
        
        // Função para renderizar os slots de horários
        function renderTimeSlots(slots, bookedSlots = [], currentTime = null) {
            console.log('🎨 === renderTimeSlots INICIADO ===');
            console.log('🎨 slots:', slots.length);
            console.log('🎨 bookedSlots:', bookedSlots.length);
            console.log('🎨 currentTime:', currentTime);
            
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            const timeInput = document.getElementById('appointmentTime');
            
            if (!timeSlotsContainer) {
                console.error('❌ timeSlotsContainer não encontrado!');
                return;
            }
            
            console.log('✅ Container encontrado');
            
            if (slots.length === 0) {
                console.warn('⚠️ Nenhum slot para renderizar');
                timeSlotsContainer.innerHTML = '<div class="time-picker-empty">Nenhum horário disponível para esta data.</div>';
                return;
            }
            
            let selectedTime = timeInput?.value || '';
            console.log('⏰ Horário selecionado anteriormente:', selectedTime || 'nenhum');
            
            // Limpar container antes de renderizar
            timeSlotsContainer.innerHTML = '';
            
            // Criar e adicionar cada slot
            slots.forEach((slot, index) => {
                const isBooked = bookedSlots.includes(slot);
                const isPast = currentTime && slot < currentTime;
                const isSelected = slot === selectedTime;
                
                let classes = 'time-slot';
                if (isBooked) classes += ' disabled';
                if (isPast) classes += ' past';
                if (isSelected) classes += ' selected';
                
                const slotDiv = document.createElement('div');
                slotDiv.className = classes;
                slotDiv.setAttribute('data-time', slot);
                slotDiv.textContent = slot;
                slotDiv.title = isBooked ? 'Horário já agendado' : isPast ? 'Horário já passou' : 'Clique para selecionar';
                
                // Adicionar event listener apenas se não estiver desabilitado
                if (!isBooked && !isPast) {
                    slotDiv.style.cursor = 'pointer';
                    slotDiv.addEventListener('click', function() {
                        console.log('⏰ Slot clicado:', slot);
                        selectTimeSlot(slot);
                    });
                } else {
                    slotDiv.style.cursor = 'not-allowed';
                }
                
                timeSlotsContainer.appendChild(slotDiv);
            });
            
            console.log('✅ Slots adicionados ao DOM:', timeSlotsContainer.children.length);
            
            // Se havia um horário selecionado, manter selecionado
            if (selectedTime) {
                const selectedSlot = timeSlotsContainer.querySelector(`[data-time="${selectedTime}"]`);
                if (selectedSlot && !selectedSlot.classList.contains('disabled') && !selectedSlot.classList.contains('past')) {
                    selectedSlot.classList.add('selected');
                    console.log('✅ Horário anterior mantido selecionado:', selectedTime);
                }
            }
            
            console.log('✅ === renderTimeSlots CONCLUÍDO ===');
        }
        
        // Função para selecionar um horário
        function selectTimeSlot(time) {
            console.log('⏰ Horário selecionado:', time);
            
            const timeInput = document.getElementById('appointmentTime');
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            
            if (!timeInput || !timeSlotsContainer) return;
            
            // Remover seleção anterior
            const previousSelected = timeSlotsContainer.querySelector('.time-slot.selected');
            if (previousSelected) {
                previousSelected.classList.remove('selected');
            }
            
            // Adicionar nova seleção
            const selectedSlot = timeSlotsContainer.querySelector(`[data-time="${time}"]`);
            if (selectedSlot) {
                selectedSlot.classList.add('selected');
                timeInput.value = time;
                console.log('✅ Horário definido:', time);
            }
        }
        window.selectTimeSlot = selectTimeSlot;
        
        // Função para renderizar serviços
        function renderServices(services, container) {
            if (!container) {
                console.error('❌ Container não encontrado para renderizar serviços');
                return;
            }
            
            if (!services || services.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <p>Nenhum serviço disponível</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = services.map((service, index) => {
                const serviceId = service.id || service.name?.replace(/\s+/g, '_').toLowerCase() || `service_${index}`;
                const serviceName = service.name || service;
                const servicePrice = service.price ? ` - R$ ${parseFloat(service.price).toFixed(2)}` : '';
                
                return `
                    <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s; user-select: none;"
                           onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(229,9,20,0.3)'"
                           onmouseout="if(!this.querySelector('input').checked) { this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)'; }">
                        <input type="checkbox" 
                               id="service_${serviceId}" 
                               name="appointment_service" 
                               value="${serviceId}"
                               data-service-name="${serviceName}"
                               data-service-price="${service.price || ''}"
                               style="width: 20px; height: 20px; cursor: pointer; accent-color: #e50914;"
                               onchange="this.parentElement.style.borderColor = this.checked ? '#e50914' : 'rgba(255,255,255,0.1)'; this.parentElement.style.background = this.checked ? 'rgba(229,9,20,0.1)' : 'rgba(255,255,255,0.05)';">
                        <span style="flex: 1; color: #fff; font-size: 15px;">${serviceName}${servicePrice}</span>
                    </label>
                `;
            }).join('');
            
            console.log('✅ Serviços renderizados:', services.length);
        }
        
        // Função para carregar serviços da barbearia
        async function loadBarbershopServices(shopId) {
            console.log('📋 === loadBarbershopServices INICIADO ===');
            console.log('📋 shopId:', shopId);
            
            const servicesContainer = document.getElementById('appointmentServices');
            
            if (!servicesContainer) {
                console.error('❌ Container de serviços não encontrado!');
                return;
            }
            
            console.log('✅ Container de serviços encontrado');
            
            // Serviços padrão que sempre serão mostrados
            const defaultServices = [
                { id: 'default_1', name: 'Corte de Cabelo', price: null },
                { id: 'default_2', name: 'Barba', price: null },
                { id: 'default_3', name: 'Corte + Barba', price: null },
                { id: 'default_4', name: 'Sobrancelha', price: null }
            ];
            
            // MOSTRAR SERVIÇOS PADRÃO IMEDIATAMENTE (não esperar busca)
            console.log('⚡ Mostrando serviços padrão imediatamente...');
            renderServices(defaultServices, servicesContainer);
            console.log('✅ Serviços padrão renderizados');
            
            // Tentar buscar serviços personalizados em background (com timeout)
            if (supabase) {
                try {
                    console.log('🔍 Buscando serviços personalizados em background...');
                    
                    // Buscar serviços personalizados com timeout
                    let services = [];
                    
                    // Tentar buscar de tabela services com timeout maior
                    try {
                        console.log('🔍 Executando query na tabela services...');
                        
                        // Tentar buscar diretamente via REST API primeiro (mais confiável)
                        let servicesData = null;
                        let servicesError = null;
                        
                        try {
                            // Usar a URL do Supabase que já está definida
                            const SUPABASE_URL_VALUE = 'https://tvvqwlxmpmolnyavabqq.supabase.co';
                            const SUPABASE_REST_URL = `${SUPABASE_URL_VALUE}/rest/v1/services?barbershop_id=eq.${shopId}&select=*&order=name.asc`;
                            console.log('🌐 Buscando via REST API:', SUPABASE_REST_URL);
                            
                            const response = await Promise.race([
                                fetch(SUPABASE_REST_URL, {
                                    method: 'GET',
                                    headers: {
                                        'apikey': SUPABASE_KEY,
                                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                                        'Content-Type': 'application/json'
                                    }
                                }),
                                new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Timeout REST API')), 3000)
                                )
                            ]);
                            
                            if (response.ok) {
                                servicesData = await response.json();
                                console.log('✅ Dados recebidos via REST API:', servicesData);
                            } else {
                                const errorText = await response.text();
                                servicesError = { message: `HTTP ${response.status}: ${errorText}` };
                                console.log('⚠️ Erro na resposta REST API:', response.status, errorText);
                            }
                        } catch (restError) {
                            console.log('⚠️ Erro ao buscar via REST API:', restError.message);
                            // Se REST API falhar, tentar via Supabase client
                            try {
                                const { data, error } = await Promise.race([
                                    supabase
                                        .from('services')
                                        .select('*')
                                        .eq('barbershop_id', shopId)
                                        .order('name', { ascending: true }),
                                    new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Timeout Supabase client')), 2000)
                                    )
                                ]);
                                
                                if (data && !error) {
                                    servicesData = data;
                                    servicesError = null;
                                } else {
                                    servicesError = error;
                                }
                            } catch (supabaseError) {
                                servicesError = { message: supabaseError.message };
                            }
                        }
                        
                        console.log('📊 Resultado da busca:', { 
                            hasData: !!servicesData, 
                            dataLength: servicesData?.length || 0,
                            hasError: !!servicesError,
                            error: servicesError?.message 
                        });
                        
                        if (!servicesError && servicesData && servicesData.length > 0) {
                            services = servicesData;
                            console.log('✅ Serviços encontrados na tabela services:', services.length, services);
                        } else if (servicesError) {
                            console.log('⚠️ Erro ao buscar da tabela services:', servicesError.message);
                            // Se erro é de tabela não encontrada, continuar
                            if (servicesError.message.includes('relation') || servicesError.message.includes('does not exist')) {
                                console.log('ℹ️ Tabela services não existe, usando serviços padrão');
                            }
                        }
                    } catch (e) {
                        console.log('⚠️ Exceção ao buscar da tabela services:', e.message);
                    }
                    
                    // Se não encontrou, tentar do campo services da barbearia
                    if (services.length === 0) {
                        try {
                            const shop = window.allBarbershops?.find(s => s.id === shopId);
                            if (shop && shop.services) {
                                if (Array.isArray(shop.services)) {
                                    services = shop.services;
                                } else if (typeof shop.services === 'string') {
                                    try {
                                        services = JSON.parse(shop.services);
                                    } catch (parseError) {
                                        services = shop.services.split(',').map(s => ({ name: s.trim(), price: null }));
                                    }
                                }
                                console.log('✅ Serviços encontrados no campo services:', services.length);
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao buscar do campo services:', e);
                        }
                    }
                    
                    // Se encontrou serviços personalizados, atualizar
                    if (services && services.length > 0) {
                        console.log('🔄 Atualizando com serviços personalizados:', services.length);
                        renderServices(services, servicesContainer);
                        console.log('✅ Serviços personalizados renderizados');
                    } else {
                        console.log('ℹ️ Nenhum serviço personalizado encontrado, mantendo padrão');
                    }
                } catch (error) {
                    console.log('⚠️ Erro ao buscar serviços personalizados (mantendo padrão):', error.message);
                    console.error('❌ Stack:', error.stack);
                    // Manter serviços padrão que já foram renderizados
                }
            } else {
                console.log('⚠️ Supabase não disponível, usando serviços padrão');
            }
            
            console.log('✅ === loadBarbershopServices CONCLUÍDO ===');
        }
        window.loadBarbershopServices = loadBarbershopServices;
        
        // Função para carregar profissionais da barbearia
        async function loadBarbershopProfessionals(shopId) {
            console.log('👥 === loadBarbershopProfessionals INICIADO ===');
            console.log('👥 shopId:', shopId);
            
            const professionalSelect = document.getElementById('appointmentProfessional');
            const professionalInfo = document.getElementById('professionalInfo');
            
            if (!professionalSelect) {
                console.error('❌ Select de profissionais não encontrado!');
                return;
            }
            
            // Limpar opções anteriores (exceto a primeira)
            professionalSelect.innerHTML = '<option value="">Selecione um profissional</option>';
            if (professionalInfo) {
                professionalInfo.style.display = 'none';
            }
            
            try {
                if (!shopId) {
                    throw new Error('ID da barbearia não fornecido');
                }
                
                // Buscar profissionais da barbearia (user_type = 'barber' e barbershop_id = shopId)
                let professionals = [];
                let lastError = null;
                
                if (supabase) {
                    try {
                        console.log('🔍 Buscando profissionais via Supabase...');
                        console.log('📋 Parâmetros:', { shopId, user_type: 'barber' });
                        
                        // Tentar buscar via REST API primeiro
                        try {
                            const SUPABASE_URL_VALUE = 'https://tvvqwlxmpmolnyavabqq.supabase.co';
                            const SUPABASE_REST_URL = `${SUPABASE_URL_VALUE}/rest/v1/profiles?barbershop_id=eq.${shopId}&user_type=eq.barber&select=id,full_name,specialty,phone,whatsapp&order=full_name.asc`;
                            console.log('🌐 Buscando via REST API:', SUPABASE_REST_URL);
                            
                            const response = await Promise.race([
                                fetch(SUPABASE_REST_URL, {
                                    method: 'GET',
                                    headers: {
                                        'apikey': SUPABASE_KEY,
                                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                                        'Content-Type': 'application/json'
                                    }
                                }),
                                new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Timeout REST API')), 8000)
                                )
                            ]);
                            
                            console.log('📊 Status da resposta REST API:', response.status, response.statusText);
                            
                            if (response.ok) {
                                professionals = await response.json();
                                console.log('✅ Profissionais encontrados via REST API:', professionals.length);
                                if (professionals.length > 0) {
                                    console.log('📋 Primeiro profissional:', professionals[0]);
                                }
                            } else {
                                const errorText = await response.text();
                                console.error('❌ Erro na resposta REST API:', response.status, errorText);
                                lastError = { status: response.status, message: errorText };
                                
                                // Tentar via Supabase client como fallback
                                console.log('🔄 Tentando via Supabase client...');
                                const { data, error } = await Promise.race([
                                    supabase
                                        .from('profiles')
                                        .select('id,full_name,specialty,phone,whatsapp')
                                        .eq('barbershop_id', shopId)
                                        .eq('user_type', 'barber')
                                        .order('full_name', { ascending: true }),
                                    new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Timeout Supabase client')), 5000)
                                    )
                                ]);
                                
                                if (error) {
                                    console.error('❌ Erro no Supabase client:', error);
                                    lastError = error;
                                } else if (data) {
                                    professionals = data;
                                    console.log('✅ Profissionais encontrados via Supabase client:', professionals.length);
                                }
                            }
                        } catch (restError) {
                            console.error('❌ Erro ao buscar via REST API:', restError);
                            lastError = restError;
                            
                            // Tentar via Supabase client como fallback
                            console.log('🔄 Tentando via Supabase client (fallback)...');
                            try {
                                const { data, error } = await Promise.race([
                                    supabase
                                        .from('profiles')
                                        .select('id,full_name,specialty,phone,whatsapp')
                                        .eq('barbershop_id', shopId)
                                        .eq('user_type', 'barber')
                                        .order('full_name', { ascending: true }),
                                    new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Timeout Supabase client')), 5000)
                                    )
                                ]);
                                
                                if (error) {
                                    console.error('❌ Erro no Supabase client (fallback):', error);
                                    lastError = error;
                                } else if (data) {
                                    professionals = data;
                                    console.log('✅ Profissionais encontrados via Supabase client (fallback):', professionals.length);
                                }
                            } catch (supabaseError) {
                                console.error('❌ Erro ao buscar profissionais (Supabase client):', supabaseError);
                                lastError = supabaseError;
                            }
                        }
                    } catch (error) {
                        console.error('❌ Erro geral ao buscar profissionais:', error);
                        lastError = error;
                    }
                } else {
                    console.error('❌ Supabase não está disponível!');
                    lastError = new Error('Supabase não disponível');
                }
                
                // Se não encontrou profissionais, tentar buscar todos os barbeiros (sem filtro de barbearia)
                // SOLUÇÃO TEMPORÁRIA: Mostrar todos os barbeiros se não encontrar da barbearia específica
                if (professionals.length === 0) {
                    console.log('🔍 Não encontrou profissionais com filtro de barbearia, tentando buscar todos os barbeiros...');
                    try {
                        const { data: allBarbers, error: allBarbersError } = await Promise.race([
                            supabase
                                .from('profiles')
                                .select('id,full_name,specialty,phone,whatsapp,barbershop_id')
                                .eq('user_type', 'barber')
                                .order('full_name', { ascending: true }),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Timeout')), 5000)
                            )
                        ]);
                        
                        if (!allBarbersError && allBarbers && allBarbers.length > 0) {
                            console.log('📊 Total de barbeiros encontrados (sem filtro):', allBarbers.length);
                            console.log('📋 Barbeiros encontrados:', allBarbers.map(b => ({
                                nome: b.full_name,
                                barbershop_id: b.barbershop_id,
                                match: b.barbershop_id === shopId
                            })));
                            
                            // SOLUÇÃO TEMPORÁRIA: Usar todos os barbeiros se não encontrou da barbearia específica
                            // Isso permite que o agendamento funcione mesmo se o barbershop_id não estiver correto
                            if (allBarbers.length > 0) {
                                console.log('⚠️ Usando todos os barbeiros como fallback (barbershop_id pode não corresponder)');
                                professionals = allBarbers;
                            } else {
                                console.log('⚠️ Nenhum barbeiro encontrado na tabela profiles (user_type = "barber")');
                            }
                            
                            console.log('💡 Dica: Verifique se os barbeiros têm o barbershop_id correto (' + shopId + ')');
                        } else if (allBarbersError) {
                            console.error('❌ Erro ao buscar todos os barbeiros:', allBarbersError);
                            lastError = allBarbersError;
                            
                            // Tentar buscar sem filtro de user_type (caso o valor esteja diferente)
                            console.log('🔍 Tentando buscar sem filtro de user_type...');
                            try {
                                const { data: allProfiles, error: profilesError } = await Promise.race([
                                    supabase
                                        .from('profiles')
                                        .select('id,full_name,specialty,phone,whatsapp,barbershop_id,user_type')
                                        .order('full_name', { ascending: true })
                                        .limit(50),
                                    new Promise((_, reject) => 
                                        setTimeout(() => reject(new Error('Timeout')), 5000)
                                    )
                                ]);
                                
                                if (!profilesError && allProfiles && allProfiles.length > 0) {
                                    console.log('📊 Total de perfis encontrados (sem filtro de user_type):', allProfiles.length);
                                    console.log('📋 Tipos de user_type encontrados:', [...new Set(allProfiles.map(p => p.user_type))]);
                                    console.log('📋 Perfis:', allProfiles.map(p => ({
                                        nome: p.full_name,
                                        user_type: p.user_type,
                                        barbershop_id: p.barbershop_id
                                    })));
                                }
                            } catch (debugError2) {
                                console.warn('⚠️ Erro ao buscar todos os perfis:', debugError2);
                            }
                        } else {
                            console.log('⚠️ Nenhum barbeiro encontrado na tabela profiles (user_type = "barber")');
                        }
                    } catch (debugError) {
                        console.warn('⚠️ Erro ao fazer busca de debug:', debugError);
                        if (!lastError) {
                            lastError = debugError;
                        }
                    }
                }
                
                // Log final
                console.log('📊 Resultado final:', {
                    profissionaisEncontrados: professionals.length,
                    temErro: !!lastError,
                    erro: lastError?.message || lastError
                });
                
                // Armazenar profissionais para uso posterior
                window.currentProfessionals = professionals || [];
                
                // Preencher select com profissionais
                if (professionals && professionals.length > 0) {
                    professionals.forEach(prof => {
                        const option = document.createElement('option');
                        option.value = prof.id;
                        option.textContent = prof.full_name || 'Profissional';
                        option.setAttribute('data-specialty', prof.specialty || '');
                        option.setAttribute('data-phone', prof.phone || '');
                        option.setAttribute('data-whatsapp', prof.whatsapp || '');
                        professionalSelect.appendChild(option);
                    });
                    console.log('✅ Profissionais carregados no select:', professionals.length);
                } else {
                    // Se não encontrou profissionais, mostrar mensagem apropriada
                    const option = document.createElement('option');
                    option.value = '';
                    
                    if (lastError) {
                        // Se houve erro, mostrar mensagem de erro
                        if (lastError.message?.includes('permission denied') || lastError.message?.includes('RLS')) {
                            option.textContent = 'Erro: Verifique permissões RLS no Supabase';
                        } else if (lastError.message?.includes('Timeout')) {
                            option.textContent = 'Erro: Timeout ao buscar profissionais';
                        } else {
                            option.textContent = 'Erro ao carregar profissionais';
                        }
                        console.error('❌ Erro ao carregar profissionais:', lastError);
                    } else {
                        // Se não houve erro, apenas não há profissionais
                        option.textContent = 'Nenhum profissional disponível';
                        console.log('⚠️ Nenhum profissional encontrado para esta barbearia (shopId: ' + shopId + ')');
                        console.log('💡 Dica: Verifique se há profissionais cadastrados com barbershop_id = ' + shopId + ' e user_type = "barber"');
                    }
                    
                    option.disabled = true;
                    professionalSelect.appendChild(option);
                }
                
                // Adicionar listener para mudança de seleção (remover listener anterior se existir)
                const existingListener = professionalSelect.dataset.hasListener;
                if (!existingListener) {
                    professionalSelect.dataset.hasListener = 'true';
                    professionalSelect.addEventListener('change', function() {
                        const selectedId = this.value;
                        if (selectedId && professionalInfo) {
                            const selectedOption = this.options[this.selectedIndex];
                            const specialty = selectedOption.getAttribute('data-specialty') || 'Não informado';
                            const phone = selectedOption.getAttribute('data-phone') || 'Não informado';
                            const whatsapp = selectedOption.getAttribute('data-whatsapp') || 'Não informado';
                            
                            const specialtyEl = document.getElementById('professionalSpecialty');
                            const phoneEl = document.getElementById('professionalPhone');
                            const whatsappEl = document.getElementById('professionalWhatsApp');
                            
                            if (specialtyEl) specialtyEl.textContent = specialty;
                            if (phoneEl) phoneEl.textContent = phone;
                            if (whatsappEl) whatsappEl.textContent = whatsapp || phone;
                            
                            professionalInfo.style.display = 'block';
                        } else {
                            if (professionalInfo) {
                                professionalInfo.style.display = 'none';
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar profissionais:', error);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Erro ao carregar profissionais';
                option.disabled = true;
                professionalSelect.appendChild(option);
            }
            
            console.log('✅ === loadBarbershopProfessionals CONCLUÍDO ===');
        }
        window.loadBarbershopProfessionals = loadBarbershopProfessionals;
        
        async function submitAppointment() {
            const alert = document.getElementById('appointmentAlert');
            const dateInput = document.getElementById('appointmentDate');
            const timeInput = document.getElementById('appointmentTime');
            const notesInput = document.getElementById('appointmentNotes');
            const submitButton = document.querySelector('#appointmentForm button[type="submit"]');
            
            // Validações básicas
            const professionalSelect = document.getElementById('appointmentProfessional');
            if (!professionalSelect?.value) {
                showAlert(alert, 'Por favor, selecione um profissional.', 'error');
                return;
            }
            
            if (!dateInput?.value || !timeInput?.value) {
                showAlert(alert, 'Por favor, preencha data e horário.', 'error');
                return;
            }
            
            // Obter usuário
            let user = window.currentUser;
            if (!user?.id) {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session?.user) {
                        showAlert(alert, 'Você precisa estar logado.', 'error');
                        return;
                    }
                    user = session.user;
                    window.currentUser = user;
                } catch (err) {
                    showAlert(alert, 'Erro de autenticação.', 'error');
                    return;
                }
            }
            
            if (!window.currentAppointmentShopId) {
                showAlert(alert, 'Erro: ID da barbearia não encontrado.', 'error');
                return;
            }
            
            // Desabilitar botão
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Criando...';
            }
            
            try {
                // Capturar serviços
                const serviceCheckboxes = Array.from(document.querySelectorAll('#appointmentServices input[type="checkbox"]:checked'));
                const selectedServices = [];
                serviceCheckboxes.forEach(checkbox => {
                    const serviceName = checkbox.getAttribute('data-service-name');
                    const servicePrice = checkbox.getAttribute('data-service-price');
                    if (serviceName) {
                        selectedServices.push(serviceName + (servicePrice ? ` - R$ ${parseFloat(servicePrice).toFixed(2)}` : ''));
                    }
                });
                
                // Obter profissional selecionado
                const professionalId = professionalSelect.value;
                const professionalName = professionalSelect.options[professionalSelect.selectedIndex]?.textContent || 'Profissional';
                
                // Preparar dados - APENAS CAMPOS OBRIGATÓRIOS
                const appointmentData = {
                    client_id: user.id,
                    barbershop_id: window.currentAppointmentShopId,
                    professional_id: professionalId,
                    appointment_date: dateInput.value,
                    appointment_time: timeInput.value,
                    status: 'pending'
                };
                
                // Adicionar notes apenas se tiver conteúdo
                const notesValue = notesInput?.value.trim();
                if (notesValue || selectedServices.length > 0) {
                    const servicesText = selectedServices.length > 0 ? `Serviços: ${selectedServices.join(', ')}` : '';
                    appointmentData.notes = notesValue 
                        ? (servicesText ? `${notesValue}\n\n${servicesText}` : notesValue)
                        : servicesText;
                }
                
                // SOLUÇÃO HÍBRIDA: localStorage + EmailJS + Supabase em background
                console.log('Salvando agendamento...', appointmentData);
                
                // 1. SALVAR LOCALMENTE PRIMEIRO (sempre funciona)
                const localAppointments = JSON.parse(localStorage.getItem('barberflix_appointments') || '[]');
                const localAppointment = {
                    ...appointmentData,
                    id: 'local_' + Date.now(),
                    created_at: new Date().toISOString(),
                    saved_locally: true
                };
                localAppointments.push(localAppointment);
                localStorage.setItem('barberflix_appointments', JSON.stringify(localAppointments));
                console.log('✅ Agendamento salvo localmente!');
                
                // 2. SALVAR NO GOOGLE SHEETS
                // ⚠️ IMPORTANTE: Google Sheets API NÃO aceita API Key para escrita (append)
                // Precisa de OAuth2, que é complexo. Por isso usamos Google Apps Script!
                
                // ✅ GOOGLE APPS SCRIPT CONFIGURADO!
                const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx-LFm3kL1W6YfYqPs3cZmEOwQAaUMmNRSKsIrJjQ3g3LVMljMvixsQQzuAQzTeOe2zjA/exec';
                
                // Salvar no Google Sheets via Apps Script:
                if (WEB_APP_URL && WEB_APP_URL.includes('script.google.com')) {
                    const webAppData = {
                        appointment_date: appointmentData.appointment_date,
                        appointment_time: appointmentData.appointment_time,
                        client_email: user.email || 'Cliente',
                        barbershop_name: window.currentAppointmentShopName || 'Barbearia',
                        professional_name: professionalName,
                        services: selectedServices.join(', ') || 'Não especificado',
                        notes: appointmentData.notes || ''
                    };
                    
                    console.log('📤 Enviando para Google Sheets...', webAppData);
                    
                    fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Apps Script requer no-cors
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(webAppData)
                    })
                    .then(() => {
                        // Com no-cors, não conseguimos ler a resposta
                        // Mas se não deu erro, provavelmente funcionou
                        console.log('✅✅✅ ENVIADO PARA GOOGLE SHEETS! ✅✅✅');
                        console.log('📋 Verifique a planilha para confirmar.');
                    })
                    .catch(err => {
                        console.warn('⚠️ Erro ao salvar no Sheets:', err);
                        console.log('💡 Dica: Verifique se o Web App está configurado com "Who has access: Anyone"');
                    });
                } else {
                    console.log('ℹ️ Google Sheets não configurado. Configure WEB_APP_URL no código.');
                    console.log('📋 Veja: SOLUCAO_GOOGLE_APPS_SCRIPT.md para instruções.');
                }
                
                // 3. ENVIAR EMAIL VIA EMAILJS (opcional - configurar depois)
                // Descomente quando configurar EmailJS:
                /*
                if (typeof emailjs !== 'undefined') {
                    const emailData = {
                        to_email: 'barbearia@email.com',
                        client_name: user.email || 'Cliente',
                        appointment_date: dateInput.value,
                        appointment_time: timeInput.value,
                        services: selectedServices.join(', ') || 'Não especificado',
                        notes: notesInput?.value.trim() || 'Nenhuma observação',
                        barbershop_name: window.currentAppointmentShopName || 'Barbearia'
                    };
                    
                    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', emailData)
                        .then(() => console.log('✅ Email enviado!'))
                        .catch(err => console.warn('⚠️ Erro ao enviar email:', err));
                }
                */
                
                // 4. TENTAR SALVAR NO SUPABASE (sem esperar - não bloqueia)
                if (supabase) {
                    supabase
                        .from('appointments')
                        .insert(appointmentData)
                        .select()
                        .then(({ data, error }) => {
                if (error) {
                                console.warn('⚠️ Falha ao salvar no Supabase (mas salvo localmente):', error);
                                localAppointment.needs_sync = true;
                                localStorage.setItem('barberflix_appointments', JSON.stringify(localAppointments));
                            } else {
                                console.log('✅ Também salvo no Supabase!', data);
                                localAppointment.supabase_id = data[0]?.id;
                                localAppointment.needs_sync = false;
                                localStorage.setItem('barberflix_appointments', JSON.stringify(localAppointments));
                            }
                        })
                        .catch(err => console.warn('⚠️ Erro ao sincronizar com Supabase:', err));
                }
                
                // 5. SUCESSO IMEDIATO (não espera nada)
                console.log('✅✅✅ AGENDAMENTO SALVO COM SUCESSO! ✅✅✅');
                showAlert(alert, '✅ Agendamento criado com sucesso!\n\nSalvo localmente e será sincronizado.', 'success');
                
                // Limpar formulário
                dateInput.value = '';
                timeInput.value = '';
                if (notesInput) notesInput.value = '';
                document.querySelectorAll('#appointmentServices input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
                
                // Fechar modal
                setTimeout(() => closeModal('appointmentModal'), 1500);
                
            } catch (error) {
                console.error('Erro crítico:', error);
                
                // Mesmo com erro, se salvou localmente, mostrar sucesso
                const localAppointments = JSON.parse(localStorage.getItem('barberflix_appointments') || '[]');
                const lastAppointment = localAppointments[localAppointments.length - 1];
                
                if (lastAppointment && lastAppointment.saved_locally) {
                    // Já foi salvo localmente, mostrar sucesso mesmo com erro
                    console.log('✅ Agendamento foi salvo localmente apesar do erro');
                    showAlert(alert, '✅ Agendamento salvo localmente!\n\nSerá sincronizado automaticamente.', 'success');
                    
                    // Limpar formulário
                    dateInput.value = '';
                    timeInput.value = '';
                    if (notesInput) notesInput.value = '';
                    document.querySelectorAll('#appointmentServices input[type="checkbox"]').forEach(cb => cb.checked = false);
                    document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
                    
                    setTimeout(() => closeModal('appointmentModal'), 1500);
                } else {
                    // Erro real
                    let msg = 'Erro ao criar agendamento.';
                    if (error.message) {
                        msg = `Erro: ${error.message}`;
                    }
                    if (alert) {
                showAlert(alert, msg, 'error');
                    } else {
                        alert(msg);
                    }
                }
            } finally {
                // SEMPRE reabilitar botão
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Confirmar Agendamento';
                    console.log('✅ Botão reabilitado');
                }
            }
        }
        window.submitAppointment = submitAppointment;
        
        async function openMyAppointments() {
            console.log('=== openMyAppointments CHAMADO ===');
            
            // Verificar pela UI primeiro (instantâneo)
            const userGreeting = document.getElementById('userGreeting');
            const isLoggedInByUI = userGreeting && getComputedStyle(userGreeting).display !== 'none';
            
            console.log('Verificação pela UI:', { isLoggedInByUI });
            
            // Se UI não mostra logado, pedir login imediatamente
            if (!isLoggedInByUI) {
                console.log('❌ UI não mostra logado, abrindo modal de autenticação');
                openModal('authRequired');
                return;
            }
            
            // Se UI mostra logado, abrir modal IMEDIATAMENTE (não bloquear)
            console.log('✅ UI mostra logado, abrindo modal imediatamente...');
            
            // Verificar se o modal existe
            const modal = document.getElementById('myAppointmentsModal');
            if (!modal) {
                console.error('❌ Modal myAppointmentsModal não encontrado no DOM!');
                alert('Erro: Modal não encontrado. Recarregue a página.');
                return;
            }
            
            console.log('✅ Modal encontrado, abrindo...');
            
            // ABRIR MODAL IMEDIATAMENTE
            openModal('myAppointmentsModal');
            
            // Verificar autenticação em background (SUPER SIMPLES!)
            console.log('🔍 Tentando obter usuário para carregar agendamentos...');
            let user = null;
            
            // PRIMEIRO: Tentar usar usuário salvo globalmente (mais rápido!)
            if (window.currentUser && window.currentUser.id) {
                user = window.currentUser;
                console.log('✅ Usuário encontrado (variável global):', user.email);
            } else {
                // Se não tem na variável global, tentar Supabase (apenas se necessário)
                if (supabase && supabase.auth) {
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session?.user) {
                            user = session.user;
                            window.currentUser = user; // Salvar para próxima vez
                            console.log('✅ Usuário encontrado (Supabase):', user.email);
                        }
                    } catch (error) {
                        console.warn('⚠️ Erro ao obter sessão:', error);
                    }
                }
            }
            
            // Carregar agendamentos se tiver user, senão mostrar mensagem
            if (user && user.id) {
                console.log('📋 Carregando agendamentos para:', user.id);
                loadMyAppointments(user.id);
            } else {
                console.log('⚠️ Não foi possível obter user, mas modal está aberto');
                console.log('⚠️ User object:', user);
                // Mostrar mensagem no modal
                const appointmentsList = document.getElementById('upcomingAppointments');
                if (appointmentsList) {
                    appointmentsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Carregando agendamentos...</p>
                        </div>
                    `;
                }
                // Tentar obter user novamente e recarregar
                setTimeout(async () => {
                    if (supabase && supabase.auth) {
                        try {
                            const { data: { session } } = await supabase.auth.getSession();
                            if (session?.user) {
                                loadMyAppointments(session.user.id);
                            }
                        } catch (e) {
                            console.warn('Erro ao recarregar:', e);
                        }
                    }
                }, 500);
            }
            
            // Atualizar menu ativo (removido navAppointments)
            document.querySelectorAll('.client-nav-item').forEach(item => {
                item.classList.remove('active');
            });
        }
        window.openMyAppointments = openMyAppointments;
        
        let currentAppointmentsTab = 'upcoming';
        
        function switchAppointmentsTab(tab) {
            currentAppointmentsTab = tab;
            
            // Atualizar botões das tabs
            const tabUpcoming = document.getElementById('tabUpcoming');
            const tabPast = document.getElementById('tabPast');
            const upcomingList = document.getElementById('upcomingAppointments');
            const pastList = document.getElementById('pastAppointments');
            
            if (tab === 'upcoming') {
                if (tabUpcoming) {
                    tabUpcoming.style.background = '#e50914';
                    tabUpcoming.style.color = '#fff';
                }
                if (tabPast) {
                    tabPast.style.background = 'transparent';
                    tabPast.style.color = '#999';
                }
                if (upcomingList) upcomingList.style.display = 'block';
                if (pastList) pastList.style.display = 'none';
            } else {
                if (tabUpcoming) {
                    tabUpcoming.style.background = 'transparent';
                    tabUpcoming.style.color = '#999';
                }
                if (tabPast) {
                    tabPast.style.background = '#e50914';
                    tabPast.style.color = '#fff';
                }
                if (upcomingList) upcomingList.style.display = 'none';
                if (pastList) pastList.style.display = 'block';
            }
        }
        window.switchAppointmentsTab = switchAppointmentsTab;
        
        async function loadMyAppointments(userId) {
            console.log('📋 Carregando agendamentos para usuário:', userId);
            
            if (!userId) {
                console.error('❌ userId não fornecido!');
                return;
            }
            
            const loadingEl = document.getElementById('appointmentsLoading');
            const contentEl = document.getElementById('appointmentsContent');
            const noAppointmentsEl = document.getElementById('noAppointments');
            const upcomingList = document.getElementById('upcomingAppointments');
            const pastList = document.getElementById('pastAppointments');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (contentEl) contentEl.style.display = 'none';
            if (noAppointmentsEl) noAppointmentsEl.style.display = 'none';
            
            try {
                // Buscar agendamentos do Supabase
                // Tentar primeiro com client_id, depois com user_id se falhar
                let appointments = null;
                let error = null;
                
                console.log('🔍 Buscando agendamentos...');
                
                // Busca SIMPLES - uma tentativa apenas
                let result1;
                try {
                    result1 = await Promise.race([
                        supabase
                            .from('appointments')
                            .select(`
                                *,
                                barbershops (
                                    id,
                                    name,
                                    phone,
                                    address,
                                    city
                                )
                            `)
                            .eq('client_id', userId)
                            .order('appointment_date', { ascending: true })
                            .order('appointment_time', { ascending: true }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('A conexão está lenta')), 15000)
                        )
                    ]);
                } catch (timeoutError) {
                    console.error('⏱️ Timeout:', timeoutError);
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (noAppointmentsEl) {
                        noAppointmentsEl.style.display = 'block';
                        noAppointmentsEl.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #e50914;">
                                <p style="font-size: 1.1rem; margin-bottom: 10px;">Conexão lenta</p>
                                <p style="color: #999; font-size: 0.9rem; margin-bottom: 20px;">Verifique sua internet e tente novamente.</p>
                                <button onclick="openMyAppointments()" style="padding: 12px 24px; background: #e50914; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                                    Tentar Novamente
                                </button>
                            </div>
                        `;
                    }
                    return;
                }
                
                console.log('📊 Resultado da busca (client_id):', {
                    hasData: !!result1.data,
                    dataLength: result1.data?.length || 0,
                    hasError: !!result1.error,
                    errorMessage: result1.error?.message
                });
                
                // A tabela só tem client_id, não user_id
                appointments = result1.data;
                error = result1.error;
                
                if (error) {
                    console.error('❌ Erro ao buscar agendamentos:', error);
                    console.error('❌ Detalhes do erro:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Mostrar mensagem de erro no modal
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (contentEl) contentEl.style.display = 'none';
                    if (noAppointmentsEl) {
                        noAppointmentsEl.style.display = 'block';
                        noAppointmentsEl.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #e50914;">
                                <p style="font-size: 1.1rem; margin-bottom: 10px;">Erro ao carregar agendamentos</p>
                                <p style="color: #999; font-size: 0.9rem;">${error.message || 'Erro desconhecido'}</p>
                            </div>
                        `;
                    }
                    return;
                }
                
                console.log('✅ Agendamentos encontrados:', appointments?.length || 0, appointments);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (!appointments || appointments.length === 0) {
                    if (contentEl) contentEl.style.display = 'none';
                    if (noAppointmentsEl) noAppointmentsEl.style.display = 'block';
                    return;
                }
                
                if (contentEl) contentEl.style.display = 'block';
                if (noAppointmentsEl) noAppointmentsEl.style.display = 'none';
                
                // Separar agendamentos futuros e passados
                const now = new Date();
                const upcoming = [];
                const past = [];
                
                appointments.forEach(apt => {
                    const aptDate = new Date(`${apt.appointment_date}T${apt.appointment_time}`);
                    if (aptDate >= now && apt.status !== 'cancelled' && apt.status !== 'completed') {
                        upcoming.push(apt);
                    } else {
                        past.push(apt);
                    }
                });
                
                // Renderizar agendamentos futuros
                if (upcomingList) {
                    if (upcoming.length === 0) {
                        upcomingList.innerHTML = `
                            <div class="empty-state" style="text-align: center; padding: 40px; color: #999;">
                                <p>Você não possui agendamentos futuros.</p>
                            </div>
                        `;
                    } else {
                        upcomingList.innerHTML = upcoming.map(apt => renderAppointmentCard(apt)).join('');
                    }
                }
                
                // Renderizar agendamentos passados
                if (pastList) {
                    if (past.length === 0) {
                        pastList.innerHTML = `
                            <div class="empty-state" style="text-align: center; padding: 40px; color: #999;">
                                <p>Você não possui agendamentos passados.</p>
                            </div>
                        `;
                    } else {
                        pastList.innerHTML = past.map(apt => renderAppointmentCard(apt)).join('');
                    }
                }
                
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) {
                    contentEl.style.display = 'block';
                    contentEl.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 40px; color: #e50914;">
                            <h3>Erro ao carregar agendamentos</h3>
                            <p>${error.message || 'Erro desconhecido'}</p>
                            <button class="btn btn-primary" onclick="loadMyAppointments('${userId}')" style="margin-top: 20px;">
                                Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }
        }
        window.loadMyAppointments = loadMyAppointments;
        
        function renderAppointmentCard(appointment) {
            const shop = appointment.barbershops || {};
            const shopName = shop.name || 'Barbearia';
            const shopAddress = shop.address && shop.city ? `${shop.address}, ${shop.city}` : '';
            const shopPhone = shop.phone || '';
            
            // Formatar data e hora
            const date = new Date(`${appointment.appointment_date}T${appointment.appointment_time}`);
            const dateStr = date.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = date.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Status
            let statusClass = 'status-pending';
            let statusText = 'Pendente';
            
            if (appointment.status === 'confirmed') {
                statusClass = 'status-confirmed';
                statusText = 'Confirmado';
            } else if (appointment.status === 'cancelled') {
                statusClass = 'status-cancelled';
                statusText = 'Cancelado';
            } else if (appointment.status === 'completed') {
                statusClass = 'status-completed';
                statusText = 'Concluído';
            }
            
            // Parse serviços do agendamento
            let servicesHTML = '';
            if (appointment.services) {
                try {
                    const services = typeof appointment.services === 'string' 
                        ? JSON.parse(appointment.services) 
                        : appointment.services;
                    
                    if (Array.isArray(services) && services.length > 0) {
                        const servicesList = services.map(s => {
                            const price = s.price ? ` - R$ ${parseFloat(s.price).toFixed(2)}` : '';
                            return `${s.name}${price}`;
                        }).join(', ');
                        
                        servicesHTML = `
                            <div class="appointment-detail-item">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <span>Serviços: ${servicesList}</span>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.warn('Erro ao parsear serviços:', e);
                }
            }
            
            return `
                <div class="appointment-card">
                    <div class="appointment-info">
                        <div class="appointment-shop-name">${shopName}</div>
                        <div class="appointment-details">
                            <div class="appointment-detail-item">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                </svg>
                                <span>${dateStr.charAt(0).toUpperCase() + dateStr.slice(1)} às ${timeStr}</span>
                            </div>
                            ${servicesHTML}
                            ${shopAddress ? `
                                <div class="appointment-detail-item">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    <span>${shopAddress}</span>
                                </div>
                            ` : ''}
                            ${shopPhone ? `
                                <div class="appointment-detail-item">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                    </svg>
                                    <span>${shopPhone}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="appointment-actions">
                        <div class="appointment-status ${statusClass}">${statusText}</div>
                        ${appointment.status !== 'cancelled' && appointment.status !== 'completed' ? `
                            <button class="btn btn-outline" onclick="cancelAppointment('${appointment.id}')" 
                                    style="padding: 8px 16px; font-size: 0.9rem;">
                                Cancelar
                            </button>
                        ` : ''}
                        ${shopPhone ? `
                            <button class="btn btn-primary" onclick="contactWhatsApp('${shopPhone.replace(/\D/g, '')}', '${shopName.replace(/'/g, "\\'")}')" 
                                    style="padding: 8px 16px; font-size: 0.9rem;">
                                Contatar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        async function cancelAppointment(appointmentId) {
            if (!confirm('Tem certeza que deseja cancelar este agendamento?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'cancelled' })
                    .eq('id', appointmentId);
                
                if (error) {
                    throw error;
                }
                
                // Recarregar agendamentos
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    await loadMyAppointments(user.id);
                }
                
                alert('Agendamento cancelado com sucesso!');
            } catch (error) {
                console.error('Erro ao cancelar agendamento:', error);
                alert('Erro ao cancelar agendamento: ' + error.message);
            }
        }
        window.cancelAppointment = cancelAppointment;
        
        function proceedToLogin() {
            console.log('proceedToLogin chamado');
            // Fechar modal de authRequired completamente
            const authModal = document.getElementById('authRequired');
            if (authModal) {
                authModal.classList.remove('active');
                authModal.style.display = 'none';
                authModal.style.visibility = 'hidden';
                authModal.style.opacity = '0';
            }
            
            // Pequeno delay para garantir que fechou
            setTimeout(() => {
                // Abrir modal de login com z-index maior
                const loginModal = document.getElementById('login');
                if (loginModal) {
                    loginModal.classList.add('active');
                    loginModal.style.display = 'flex';
                    loginModal.style.visibility = 'visible';
                    loginModal.style.opacity = '1';
                    loginModal.style.position = 'fixed';
                    loginModal.style.top = '0';
                    loginModal.style.left = '0';
                    loginModal.style.right = '0';
                    loginModal.style.bottom = '0';
                    loginModal.style.width = '100%';
                    loginModal.style.height = '100%';
                    loginModal.style.zIndex = '9999'; // Z-index maior
                    loginModal.style.alignItems = 'center';
                    loginModal.style.justifyContent = 'center';
                    loginModal.style.background = 'rgba(0,0,0,0.9)';
                    document.body.style.overflow = 'hidden';
                    console.log('Modal de login aberto');
                } else {
                    console.error('Modal login não encontrado!');
                }
            }, 100);
        }
        window.proceedToLogin = proceedToLogin;
        
        function proceedToRegister() {
            console.log('proceedToRegister chamado');
            // Fechar modal de authRequired completamente
            const authModal = document.getElementById('authRequired');
            if (authModal) {
                authModal.classList.remove('active');
                authModal.style.display = 'none';
                authModal.style.visibility = 'hidden';
                authModal.style.opacity = '0';
            }
            
            // Pequeno delay para garantir que fechou
            setTimeout(() => {
                // Abrir modal de registro com z-index maior
                const registerModal = document.getElementById('register');
                if (registerModal) {
                    registerModal.classList.add('active');
                    registerModal.style.display = 'flex';
                    registerModal.style.visibility = 'visible';
                    registerModal.style.opacity = '1';
                    registerModal.style.position = 'fixed';
                    registerModal.style.top = '0';
                    registerModal.style.left = '0';
                    registerModal.style.right = '0';
                    registerModal.style.bottom = '0';
                    registerModal.style.width = '100%';
                    registerModal.style.height = '100%';
                    registerModal.style.zIndex = '9999'; // Z-index maior
                    registerModal.style.alignItems = 'center';
                    registerModal.style.justifyContent = 'center';
                    registerModal.style.background = 'rgba(0,0,0,0.9)';
                    document.body.style.overflow = 'hidden';
                    console.log('Modal de registro aberto');
                } else {
                    console.error('Modal register não encontrado!');
                }
            }, 100);
        }
        window.proceedToRegister = proceedToRegister;
        
        async function updateUserInfo() {
            try {
                console.log('updateUserInfo iniciado');
                
                if (!supabase) {
                    console.warn('Supabase não disponível para updateUserInfo');
                    return;
                }
                
                // Se está processando login manualmente, aguardar um pouco antes de atualizar
                if (isHandlingLogin) {
                    console.log('Login sendo processado manualmente, aguardando antes de atualizar...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                console.log('Buscando usuário...');
                // Usar getSession primeiro (mais rápido e confiável)
                let user = null;
                let error = null;
                
                try {
                    // PRIMEIRO: Tentar usar usuário salvo globalmente (mais rápido!)
                    if (window.currentUser && window.currentUser.id) {
                        user = window.currentUser;
                        console.log('✅ Usuário encontrado (variável global):', user.email);
                    } else {
                        // Tentar getSession primeiro (lê do localStorage, mais rápido)
                        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                        if (session?.user && !sessionError) {
                            user = session.user;
                            window.currentUser = user; // Salvar para próxima vez
                            console.log('✅ Usuário encontrado via getSession:', user.email);
                        } else {
                        // Se getSession não retornar, tentar getUser com timeout curto
                        console.log('getSession não retornou usuário, tentando getUser...');
                        try {
                            const getUserPromise = supabase.auth.getUser();
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Timeout no getUser')), 2000)
                            );
                            const result = await Promise.race([getUserPromise, timeoutPromise]);
                            user = result?.data?.user;
                            error = result?.error;
                            if (user) {
                                window.currentUser = user; // Salvar para próxima vez
                                console.log('✅ Usuário encontrado via getUser:', user.email);
                            } else if (error) {
                                console.warn('getUser retornou erro:', error);
                            }
                        } catch (getUserError) {
                            console.warn('getUser falhou ou deu timeout:', getUserError);
                            error = getUserError;
                        }
                    }
                    }
                } catch (sessionError) {
                    console.error('Erro ao obter sessão:', sessionError);
                    error = sessionError;
                }
                
            const userGreeting = document.getElementById('userGreeting');
            const loginButtons = document.getElementById('loginButtons');
            
                console.log('Elementos encontrados:', {
                    userGreeting: !!userGreeting,
                    loginButtons: !!loginButtons,
                    user: !!user,
                    error: error?.message
                });
                
                if (!userGreeting || !loginButtons) {
                    console.warn('Elementos de UI não encontrados');
                    return;
                }
                
                // Verificar se já está exibindo corretamente antes de mudar
                const currentUserGreetingDisplay = getComputedStyle(userGreeting).display;
                const currentLoginButtonsDisplay = getComputedStyle(loginButtons).display;
                
                console.log('Estado atual da UI:', {
                    userGreetingDisplay: currentUserGreetingDisplay,
                    loginButtonsDisplay: currentLoginButtonsDisplay
                });
                
                if (user && !error) {
                // Usuário logado
                    console.log('✅ Usuário logado, atualizando UI:', user.email);
                    
                    // FORÇAR exibição com !important
                    userGreeting.style.setProperty('display', 'inline-flex', 'important');
                    userGreeting.style.setProperty('visibility', 'visible', 'important');
                    userGreeting.style.setProperty('opacity', '1', 'important');
                    
                    // FORÇAR ocultação com !important
                    loginButtons.style.setProperty('display', 'none', 'important');
                    loginButtons.style.setProperty('visibility', 'hidden', 'important');
                    
                    console.log('UI atualizada:', {
                        userGreetingDisplay: userGreeting.style.display,
                        loginButtonsDisplay: loginButtons.style.display,
                        computed: getComputedStyle(userGreeting).display
                    });
                
                    // Buscar perfil para verificar tipo de usuário
                    let userType = 'client';
                    try {
                const { data: profile } = await supabase
                    .from('profiles')
                            .select('full_name, user_type')
                    .eq('id', user.id)
                    .maybeSingle();
                
                        if (profile) {
                            userType = profile.user_type || 'client';
                        }
                        
                        // Mostrar apenas o primeiro nome
                const clientName = profile?.full_name || user.email?.split('@')[0] || 'Usuário';
                        const firstName = clientName.split(' ')[0]; // Pegar apenas o primeiro nome
                        const greetingText = document.getElementById('userGreetingText');
                        if (greetingText) {
                            greetingText.textContent = `Olá, ${firstName}`;
                        }
                        
                        // Mostrar menu de navegação apenas para clientes
                        const clientNavMenu = document.getElementById('clientNavMenu');
                        const registerShopBtn = document.getElementById('registerShopBtn');
                        if (clientNavMenu) {
                            if (userType === 'client') {
                                clientNavMenu.style.setProperty('display', 'flex', 'important');
                                // Esconder botão de cadastrar barbearia para clientes
                                if (registerShopBtn) {
                                    registerShopBtn.style.setProperty('display', 'none', 'important');
                                }
            } else {
                                clientNavMenu.style.setProperty('display', 'none', 'important');
                                // Mostrar botão de cadastrar barbearia para não-clientes
                                if (registerShopBtn) {
                                    registerShopBtn.style.setProperty('display', 'inline-block', 'important');
                                }
                            }
                        }
                    } catch (profileError) {
                        console.warn('Erro ao buscar perfil:', profileError);
                        const greetingText = document.getElementById('userGreetingText');
                        if (greetingText) {
                            const firstName = user.email?.split('@')[0] || 'Usuário';
                            greetingText.textContent = `Olá, ${firstName}`;
                        }
                        // Por padrão, mostrar menu para clientes
                        const clientNavMenu = document.getElementById('clientNavMenu');
                        if (clientNavMenu) {
                            clientNavMenu.style.display = 'flex';
                        }
                    }
                    
                    console.log('✅ updateUserInfo concluído com sucesso para usuário logado');
                } else {
                    // Usuário não logado - mas só atualizar se realmente não estiver logado
                    // Verificar novamente se não há sessão ativa antes de esconder
                    try {
                        const sessionCheck = await supabase.auth.getSession();
                        if (sessionCheck.data?.session) {
                            console.log('⚠️ Sessão encontrada mesmo após getUser falhar, mantendo UI de logado');
                            // Se há sessão, manter UI de logado e tentar buscar usuário novamente
                            userGreeting.style.setProperty('display', 'inline-flex', 'important');
                            loginButtons.style.setProperty('display', 'none', 'important');
                            // Tentar buscar usuário da sessão
                            const sessionUser = sessionCheck.data.session.user;
                            if (sessionUser) {
                                const greetingText = document.getElementById('userGreetingText');
                                if (greetingText) {
                                    const firstName = sessionUser.email?.split('@')[0] || 'Usuário';
                                    greetingText.textContent = `Olá, ${firstName}`;
                                }
                                const clientNavMenu = document.getElementById('clientNavMenu');
                                if (clientNavMenu) {
                                    clientNavMenu.style.setProperty('display', 'flex', 'important');
                                }
                            }
                            console.log('✅ updateUserInfo concluído com sessão encontrada');
                            return; // Não continuar com lógica de não logado
                        }
                    } catch (sessionCheckError) {
                        console.warn('Erro ao verificar sessão:', sessionCheckError);
                    }
                    
                    console.log('Usuário não logado, mostrando botões de login');
                    
                    // FORÇAR ocultação
                    userGreeting.style.setProperty('display', 'none', 'important');
                    userGreeting.style.setProperty('visibility', 'hidden', 'important');
                    
                    // FORÇAR exibição
                    loginButtons.style.setProperty('display', 'flex', 'important');
                    loginButtons.style.setProperty('visibility', 'visible', 'important');
                    
                    // Esconder menu de navegação
                    const clientNavMenu = document.getElementById('clientNavMenu');
                    const registerShopBtn = document.getElementById('registerShopBtn');
                    if (clientNavMenu) {
                        clientNavMenu.style.setProperty('display', 'none', 'important');
                    }
                    // Mostrar botão de cadastrar barbearia quando não logado
                    if (registerShopBtn) {
                        registerShopBtn.style.setProperty('display', 'inline-block', 'important');
                    }
                    
                    console.log('✅ updateUserInfo concluído para usuário não logado');
                }
            } catch (error) {
                console.error('❌ Erro em updateUserInfo:', error);
                console.error('Stack:', error.stack);
            }
            
            console.log('=== FIM updateUserInfo ===');
        }
        
        // Carregar barbearias ao iniciar - SEMPRE, mesmo sem login
        async function initPage() {
            try {
                console.log('Inicializando página...');
                
                // SEMPRE carregar barbearias primeiro, independente de login
                await loadBarbershops();
                
                // Depois atualizar informações do usuário (se estiver logado)
                // O Supabase gerencia a sessão automaticamente
                await updateUserInfo();
                
                // Verificar se há shopId na URL
                const urlParams = new URLSearchParams(window.location.search);
                const shopId = urlParams.get('shop');
                if (shopId) {
                    // Após fazer login, mostrar a barbearia específica
                    const checkLogin = setInterval(async () => {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user) {
                            clearInterval(checkLogin);
                            viewBarbershop(shopId);
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Erro ao inicializar:', error);
            }
        }
        
        // Executar imediatamente quando o script carrega
        console.log('Script carregado, estado do documento:', document.readyState);
        
        if (document.readyState === 'loading') {
            console.log('DOM ainda carregando, aguardando DOMContentLoaded...');
            window.addEventListener('DOMContentLoaded', () => {
                console.log('DOMContentLoaded disparado');
                initPage();
            });
        } else {
            console.log('DOM já carregado, executando imediatamente');
            // DOM já carregado, executar imediatamente
            initPage();
        }
        
        // Garantir que carregue mesmo se o script carregar depois
        window.addEventListener('load', async () => {
            console.log('Window load disparado');
            if (!window.allBarbershops || window.allBarbershops.length === 0) {
                console.log('Barbearias não carregadas, tentando novamente...');
                await initPage();
            }
        });
        
        // Listener para mudanças de autenticação do Supabase
        if (supabase && supabase.auth && supabase.auth.onAuthStateChange) {
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Mudança de estado de autenticação:', event, session);
                
                // Se já está processando login manualmente, não fazer nada aqui
                if (isHandlingLogin) {
                    console.log('Login já está sendo processado manualmente, ignorando listener completamente');
                    return;
                }
                
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                // Aguardar um pouco para garantir que não está em processo de login
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Verificar novamente se não está processando login
                if (isHandlingLogin) {
                    console.log('Ainda processando login, ignorando listener');
                    return;
                }
                
                console.log('Atualizando UI após mudança de autenticação...');
                await updateUserInfo();
                
                // Apenas recarregar barbearias se não estiver processando login
                if (!isHandlingLogin) {
                console.log('Recarregando barbearias após mudança de autenticação...');
                await loadBarbershops();
                }
            }
            });
        }
        
        async function handleLogout() {
            console.log('=== handleLogout CHAMADO ===');
            try {
                // LIMPAR USUÁRIO GLOBAL IMEDIATAMENTE (SIMPLES!)
                window.currentUser = null;
                console.log('✅ Usuário global limpo');
                
                if (supabase && supabase.auth) {
                    console.log('Fazendo signOut...');
                    try {
                        // Adicionar timeout para evitar travamento
                        const signOutPromise = supabase.auth.signOut();
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout no signOut')), 5000)
                        );
                        
                        const { error } = await Promise.race([signOutPromise, timeoutPromise]);
                        if (error) {
                            console.error('Erro ao fazer signOut:', error);
                            // Continuar mesmo com erro para atualizar UI
                        } else {
                            console.log('✅ SignOut realizado com sucesso');
                        }
                    } catch (signOutError) {
                        console.warn('Erro ou timeout no signOut, continuando com atualização de UI:', signOutError);
                        // Continuar mesmo com erro
                    }
                } else {
                    console.warn('Supabase não disponível para signOut');
                }
                
                // Atualizar UI IMEDIATAMENTE após logout - SEMPRE
                console.log('Atualizando UI após logout...');
                const userGreeting = document.getElementById('userGreeting');
                const loginButtons = document.getElementById('loginButtons');
                const clientNavMenu = document.getElementById('clientNavMenu');
                const registerShopBtn = document.getElementById('registerShopBtn');
                
                console.log('Elementos encontrados:', {
                    userGreeting: !!userGreeting,
                    loginButtons: !!loginButtons,
                    clientNavMenu: !!clientNavMenu,
                    registerShopBtn: !!registerShopBtn
                });
                
                if (userGreeting) {
                    userGreeting.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
                    console.log('✅ userGreeting ocultado');
                } else {
                    console.error('❌ userGreeting não encontrado!');
                }
                
                if (loginButtons) {
                    loginButtons.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    console.log('✅ loginButtons exibido');
                } else {
                    console.error('❌ loginButtons não encontrado!');
                }
                
                if (clientNavMenu) {
                    clientNavMenu.style.cssText = 'display: none !important; visibility: hidden !important;';
                    console.log('✅ clientNavMenu ocultado');
                }
                
                if (registerShopBtn) {
                    registerShopBtn.style.cssText = 'display: inline-block !important; visibility: visible !important;';
                    console.log('✅ registerShopBtn exibido');
                }
                
                // Verificar se funcionou
                setTimeout(() => {
                    const checkGreeting = document.getElementById('userGreeting');
                    const checkButtons = document.getElementById('loginButtons');
                    const greetingDisplay = checkGreeting ? getComputedStyle(checkGreeting).display : 'none';
                    const buttonsDisplay = checkButtons ? getComputedStyle(checkButtons).display : 'none';
                    console.log('Verificação após logout:', {
                        userGreetingDisplay: greetingDisplay,
                        loginButtonsDisplay: buttonsDisplay
                    });
                    
                    if (greetingDisplay !== 'none' || buttonsDisplay === 'none') {
                        console.warn('⚠️ UI não atualizou corretamente, forçando novamente...');
                        if (checkGreeting) checkGreeting.style.cssText = 'display: none !important;';
                        if (checkButtons) checkButtons.style.cssText = 'display: flex !important;';
                    }
                }, 100);
                
                console.log('✅ UI atualizada após logout');
                
                // Chamar updateUserInfo para sincronizar (com timeout)
                try {
                    console.log('Chamando updateUserInfo...');
                    const updatePromise = updateUserInfo();
                    const updateTimeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout no updateUserInfo')), 3000)
                    );
                    await Promise.race([updatePromise, updateTimeout]);
                    console.log('✅ updateUserInfo concluído');
                } catch (updateError) {
                    console.warn('Erro ou timeout no updateUserInfo, mas logout já foi concluído:', updateError);
                }
                
                console.log('✅ Logout concluído completamente');
            } catch (error) {
                console.error('❌ Erro ao fazer logout:', error);
                console.error('Stack:', error.stack);
                alert('Erro ao fazer logout: ' + error.message);
            }
        }
        window.handleLogout = handleLogout;
        window.logout = handleLogout; // Manter compatibilidade
        
        function showAlert(element, message, type) {
            if (!element) {
                console.warn('Elemento de alerta não encontrado');
                return;
            }
            element.textContent = message;
            element.className = `alert alert-${type} show`;
            element.style.display = 'block';
            setTimeout(() => {
                element.classList.remove('show');
                setTimeout(() => {
                    element.style.display = 'none';
                    element.textContent = '';
                }, 300);
            }, 5000);
        }
        
        let currentShareShopId = null;
        let currentShareShopName = null;
        
        function openShareModal(shopId, shopName) {
            console.log('openShareModal chamado:', shopId, shopName);
            currentShareShopId = shopId;
            currentShareShopName = shopName;
            const shareUrl = generateShareLink(shopId);
            document.getElementById('shareLinkInput').value = shareUrl;
            document.getElementById('shareShopName').textContent = `Compartilhe "${shopName}" com seus amigos!`;
            openModal('shareModal');
        }
        window.openShareModal = openShareModal;
        
        function generateShareLink(shopId) {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?shop=${shopId}`;
        }
        
        async function copyShareLink() {
            const input = document.getElementById('shareLinkInput');
            input.select();
            input.setSelectionRange(0, 99999);
            
            try {
                await navigator.clipboard.writeText(input.value);
                const successMsg = document.getElementById('copySuccess');
                successMsg.classList.add('show');
                setTimeout(() => successMsg.classList.remove('show'), 3000);
            } catch (err) {
                // Fallback para navegadores antigos
                document.execCommand('copy');
                const successMsg = document.getElementById('copySuccess');
                successMsg.classList.add('show');
                setTimeout(() => successMsg.classList.remove('show'), 3000);
            }
        }
        
        function shareWhatsApp() {
            const url = encodeURIComponent(document.getElementById('shareLinkInput').value);
            const text = encodeURIComponent(`Confira esta barbearia no Barberflix: ${currentShareShopName}`);
            window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
        }
        
        function shareEmail() {
            const url = document.getElementById('shareLinkInput').value;
            const subject = encodeURIComponent(`Confira ${currentShareShopName} no Barberflix`);
            const body = encodeURIComponent(`Olá!\n\nConfira esta barbearia no Barberflix:\n${currentShareShopName}\n\n${url}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }
        
        function shareFacebook() {
            const url = encodeURIComponent(document.getElementById('shareLinkInput').value);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }
        
        function shareTwitter() {
            const url = encodeURIComponent(document.getElementById('shareLinkInput').value);
            const text = encodeURIComponent(`Confira ${currentShareShopName} no Barberflix`);
            window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
        }
        
        
        async function handleGoogleLogin() {
            const alert = document.getElementById('loginAlert');
            
            try {
                if (!supabase) {
                    if (alert) {
                        showAlert(alert, '⚠️ Erro: Supabase não está configurado corretamente.', 'error');
                    } else {
                        alert('Erro: Supabase não está configurado corretamente.');
                    }
                    return;
                }
                
                console.log('🔵 Tentando login com Google...');
                
                // Simplificar configuração do OAuth
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href,
                        skipBrowserRedirect: false
                    }
                });
                
                if (error) {
                    console.error('❌ Erro no login Google:', error);
                    console.error('Código do erro:', error.code);
                    console.error('Mensagem:', error.message);
                    console.error('Status:', error.status);
                    
                    // Tratar diferentes tipos de erro
                    let errorMessage = 'Erro desconhecido ao fazer login com Google';
                    
                    if (error.code === 400 || error.status === 400) {
                        errorMessage = '⚠️ Login com Google não está configurado ou habilitado no Supabase.\n\n' +
                                     'Para habilitar:\n' +
                                     '1. Acesse o dashboard do Supabase\n' +
                                     '2. Vá em Authentication > Providers\n' +
                                     '3. Habilite o Google OAuth\n' +
                                     '4. Configure Client ID e Client Secret\n' +
                                     '5. Adicione esta URL aos Redirect URLs: ' + window.location.href + '\n\n' +
                                     'Por enquanto, use email e senha para fazer login.';
                    } else if (error.message) {
                        if (error.message.includes('not enabled') || 
                            error.message.includes('provider is not enabled') ||
                            error.message.includes('Unsupported provider')) {
                            errorMessage = '⚠️ Login com Google não está habilitado no Supabase.\n\nConfigure no dashboard: Authentication > Providers > Google\n\nPor enquanto, use email e senha para fazer login.';
                        } else {
                            errorMessage = `Erro ao fazer login com Google: ${error.message}`;
                        }
                    }
                    
                    if (alert) {
                        showAlert(alert, errorMessage, 'error');
                    } else {
                        alert(errorMessage);
                    }
                } else {
                    console.log('✅ Login Google iniciado com sucesso, redirecionando...');
                    // O redirecionamento será feito automaticamente pelo Supabase
                    if (alert) {
                        showAlert(alert, 'Redirecionando para o Google...', 'success');
                    }
                }
            } catch (error) {
                console.error('❌ ERRO ao fazer login com Google:', error);
                console.error('Stack:', error.stack);
                const errorMessage = error.message || 'Erro desconhecido ao fazer login com Google';
                
                let displayMessage = errorMessage;
                if (errorMessage.includes('not enabled') || errorMessage.includes('provider is not enabled')) {
                    displayMessage = '⚠️ Login com Google não está habilitado no Supabase. Use email e senha para fazer login.';
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                    displayMessage = '⚠️ Erro de conexão. Verifique sua internet e tente novamente.';
                }
                
                if (alert) {
                    showAlert(alert, displayMessage, 'error');
                } else {
                    alert('Erro ao fazer login com Google: ' + displayMessage);
                }
            }
        }
        window.handleGoogleLogin = handleGoogleLogin;
        
        let selectedPlan = 'premium';
        
        function selectPlan(plan, element) {
            selectedPlan = plan;
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            } else {
                event?.currentTarget?.classList.add('selected');
            }
        }
        
        function proceedToRegister() {
            closeModal('plans');
            // Aqui você pode redirecionar para página de cadastro de barbearia
            // ou abrir um modal de cadastro passando o plano selecionado
            alert(`Plano ${selectedPlan} selecionado! Em breve você poderá cadastrar sua barbearia.`);
            // Exemplo: window.location.href = `barberflix-cadastro-barbearia.html?plan=${selectedPlan}`;
        }
        // Prevenir zoom em inputs no iOS
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type !== 'file') {
                    input.style.fontSize = '16px'; // Previne zoom no iOS
                }
            });
        });
        
        // Listener para redimensionamento da janela
        window.addEventListener('resize', () => {
            // Ajustar layout se necessário
            if (window.innerWidth > 768) {
                // Desktop - garantir que elementos estejam visíveis
            }
        });
    </script>
</body>
</html>

